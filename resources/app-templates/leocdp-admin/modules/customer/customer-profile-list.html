<!-- customer data profile list  -->

<div class="row">
    <div class="col-lg-6">
        <h5 class="page-header" id="page_breadcrumb" > </h5>
    </div>
    <div class="col-lg-6 text-right" style="padding: 10px">
    	<button type="button" class="btn btn-do-now" onclick="location.reload()" title="Refresh Profile List" > 
    		<i class="fa fa-refresh" aria-hidden="true"></i> Refresh
    	</button>
    	<button type="button" class="btn btn-info data-control-update" onclick="mergeDuplicatesHandler()" title="Merge duplicated profiles into a single profile" > 
    		<i class="fa fa-compress" aria-hidden="true"></i> Deduplicate
    	</button>
    	<button type="button" class="btn btn-primary data-control-update" onclick="importProfileHandler()" title="Import Profiles" > 
    		<i class="fa fa-cloud-upload" aria-hidden="true"></i> Import Data
    	</button>
    	<button type="button" class="btn btn-goto-router data-control-insert" onclick="newProfileHandler()" title="New Profile Editor"> 
    		<i class="fa fa-plus-circle" aria-hidden="true"></i> New Profile 
    	</button>
    </div>
</div>
    
<div class="top_page_header" >
	<h4> <i class="fa fa-users" aria-hidden="true"></i> Profile Data Management </h4>
</div>

<div id="profile_list_loader" class="loader"></div>
<div id="profile_list" style="display: none;" >	

	<!-- profile filter -->	
	<div class="panel panel-info" >
	   	<div class="panel-heading">
	   		<b> <i class="fa fa-search" aria-hidden="true"></i> Data Query Filter </b>
	   	</div>
	    <div class="panel-body">
	      	<div class="col-md-12 row">
				
				<div class="col-md-6" style="background-color:#f5f5f5; border-radius: 5px;padding-top: 5px"> 
					<div id="filterByJourneyMap" class="col-md-12" style="padding-bottom: 10px" >
      					<select id="journeyMapList" class="form-control" data-placeholder="Choose an Journey Map" class="select" > </select>
			  		</div>
					<div class="col-md-12">
						<label title="Filter all profiles that have mobile phone or email" > 
								<input id="filterOnlyContactable" type="checkbox" onchange="filterOnlyContactableProfiles(this)" > Filter contact profiles  
						</label>
					</div> 
					<div class="col-md-12">
						<label title="Filter all profiles within the specified date range"> 
							<input id="disable_date_filter" type="checkbox" onclick="toggleProfileDisableDateFilter(false)" > Turn off date filter 
						</label>
						
					</div> 
					<div class="col-md-12">
						<div id='beginFilterDateHolder' class="col-md-6"> 
							<div class="form-group">
				            	<b>Since the updated date </b>
				                <div class='input-group date' id='beginFilterDate'>
				                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
						<div id='endFilterDateHolder' class="col-md-6"> 
							<div class="form-group">
				           	 	<b> To the last updated date </b>
				                <div class='input-group date' id='endFilterDate'>
				                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
					</div>
				</div>
				
				<div class="col-md-6" > 
					<div class="col-md-6" >
						<div class="dropdown">
						    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Advanced Filter
						    <span class="caret"></span></button>
						    <ul class="dropdown-menu">
						    	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByProfileId')" >Profile ID</a></li>
						    	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterEmail')" >Primary Email</a></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterPhone')" >Primary Phone</a></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByVisitorId')" >Web Visitor ID</a></li>
						      	<li><hr></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterProfileListByStatus')" >Profile Status</a></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByDataLabel')" >Data Label</a></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByLastTouchpoint')" >Last Touchpoint Name</a></li>
						      	<li><hr></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByAuthorizedViewer')" >Authorized Viewer</a></li>
						      	<li><a href="javascript:" onclick="handleProfileListFiltersBy(this,'#filterByAuthorizedEditor')" >Authorized Editor</a></li>
						    </ul>
						</div>
						<div id="profile_filter_inputs" >
							<label id="profile_filter_input_label" style="margin-top:10px;" >Profile Status</label>
							<input type="hidden" id="filterName" value="" >
							
							<input style="display: none;" type="text" class="form-control" id="filterByProfileId" placeholder="Enter profile ID" >
							<select class="form-control" id="filterProfileListByStatus" >
						    	<option value="">ACTIVE PROFILES</option>
						    	<option value="0">INACTIVE PROFILES</option>
						    	<option value="-1">INVALID PROFILES</option>
						    	<option value="-4">REMOVED PROFILES</option>
						    </select>
							
							<input style="display: none;" type="text" class="form-control" id="filterEmail" placeholder="Enter email" >
							<input style="display: none;" type="text" class="form-control" id="filterPhone" placeholder="Enter phone number" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByVisitorId" placeholder="Enter web visitor ID" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByDataLabel" placeholder="Enter data label" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByAuthorizedViewer" placeholder="Enter login username of viewer" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByAuthorizedEditor" placeholder="Enter login username of editor" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByLastTouchpoint" placeholder="Enter touchpoint name" >
					  		
						</div>
					</div>
					<div class="col-md-6" >
						<div class="col-md-12" style="padding-top:25px;">
							<div class="col-md-6" style="text-align: right;">
							 	<button type="button" class="btn btn-do-now" onclick="resetProfileSearch()" ><i class="fa fa-fw fa-undo"></i> Reset </button>
							</div>
							<div class="col-md-6" >
							 	<button type="button" class="btn btn-goto-router" onclick="doProfileListing()" ><i class="fa fa-fw fa-filter"></i> Filter </button>
							</div>
						</div>
						<div id="holder_deleteNotActiveProfile" class="col-md-12 text-center" style="padding-top:15px; display: none;" >
						 	<button type="button" class="btn btn-danger" onclick="deleteNotActiveProfile()" >
						 		<i class="fa fa-fw fa-trash"></i> DELETE ALL <span id="btn_deleteNotActiveProfile"></span>
						 	</button>
						</div>
					</div>
				</div>
			</div>
	    </div>
	</div>
    
    <!-- profile list -->
	<div class="row gridholder">
	    <div class="col-lg-12">
	        <div class="table-responsive">
	        	
	            <table id="profile_list_table" class="display" style="width:100%;">
	                <thead>
	                    <tr>
	                        <th class="text-center" title="A profile that has mobile phone or email">Contact Data</th>
	                        <th> Full Name </th>
	                        <th class="text-center">Email</th>
	                        <th class="text-center">Phone</th>
	                        <th class="text-center">Last-seen Touchpoint</th>
	                        <th class="text-center">Data Quality</th>
	                        <th class="text-center">Lead Score</th>
	                        <th class="text-center">CLV Score</th>	                        
	                        <th class="text-center">Updated</th>
	                        <th class="text-center">Status</th>
	                        <th class="text-center">Actions</th>
	                    </tr>
	                </thead>
	            </table>
	        </div>
	    </div>
	</div>
	
</div>
    
<script>
	var currentJourneyMapId = "", profileListTable = false;
	
	function toggleProfileDisableDateFilter(disableBySearch) {
		var checked = $('#disable_date_filter:checked').length === 1;
		if(checked || disableBySearch === true) {
			$('#beginFilterDateHolder').hide();
			$('#endFilterDateHolder').hide();
			if(disableBySearch) {
				$('#disable_date_filter').prop('checked', true);
			}
		} else {
			$('#beginFilterDateHolder').show();
			$('#endFilterDateHolder').show();
			$('#disable_date_filter').prop('checked', false);
		}
	}
	
	function showDeleteNotActiveProfile(){
		var selected = $("#filterProfileListByStatus").val();
		if(selected === ""){
			$('#holder_deleteNotActiveProfile').hide()
		}
		else {
			var text = $('#filterProfileListByStatus option:selected').text().trim();
			$('#btn_deleteNotActiveProfile').text(text)
			$('#holder_deleteNotActiveProfile').show()
		}
	}
	
	function deleteNotActiveProfile() {
		var status = $("#filterProfileListByStatus").val();
		var statusValue = -4;
		if(status != ""){
			statusValue = parseInt(status);
		}
		LeoAdminApiUtil.callPostAdminApi('/cdp/profiles/delete-not-active', {'status' : statusValue}, function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
            	iziToast.info({
		    	    title: 'Profile Data Management',
		    	    message: 'Deleted ' + json.data + ' profiles'
		    	});
            	resetProfileSearch();
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
       });
	}
	
	function doProfileListing() {
		var keywords = $('#main_search_profile').val().trim();
    	if(keywords.length > 1){
    		var encodedString = Base64.encode(keywords);
    		location.hash = "calljs-leoCdpRouter('Customer_Profile_Search','" + encodedString + "')";
    	} 
    	$('#profile_list_table').DataTable().clear();
	    $('#profile_list_table').DataTable().ajax.reload();
	    showDeleteNotActiveProfile()
	}
	
	function filterOnlyContactableProfiles(node){
		if($(node).prop('checked')) {
			toggleProfileDisableDateFilter(true);
		} 
	}
	
	function resetProfileSearch() {
		if(LeoCdpAdmin.routerKey === "Customer_Profile_Search" ){
			$('#main_search_profile').val('');
			location.hash = "calljs-leoCdpRouter('Profile_Management')";
		} else {
			$('#filterOnlyContactable').prop('checked', false);
			
			// reset filter data
			$('#filterEmail, #filterPhone, #filterByVisitorId, #filterByProfileId, #filterByLastTouchpoint, #filterByDataLabel, #filterByAuthorizedViewer, #filterByAuthorizedEditor').val('');
			
			$('#filterProfileListByStatus').val('');
			$('#filterName').val('');
			$('#journeyMapList').val("").change().trigger("chosen:updated");
			
			$('#main_search_profile').val('');
			$('#beginFilterDate > .form-control').show();
			$('#endFilterDate > .form-control').show();
			$('#disable_date_filter').prop('checked', false);
			doProfileListing();
		}
	}
	
	var newProfileHandler = function (){
		if( $("#profile_list_table").data('canInsertData') ){
			gotoLeoCdpRouter('Customer_Profile_Editor', 'new' );
		} else {
			errorNoAuthorization();
		}
	}
	
	var importProfileHandler = function(){
		location.hash = "calljs-leoCdpRouter('Customer_Profile_Import')";
	}
	
	var mergeDuplicatesCallback = function(){
		iziToast.success({
    	    title: 'Merge Duplicate Profile',
    	    onClosed: function(){
    	    	location.reload();
    	    },
    	    message: 'Data is merged successfully!'
    	});
	}
	
	var mergeDuplicatesHandler = function() {
		LeoAdminApiUtil.callPostAdminApi('/cdp/profiles/merge-duplicates', {'mergeStrategy' : 'automation'}, function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
    			if(json.data){
    				iziToast.info({
    		    	    title: 'Merge Duplicate Profile',
    		    	    message: 'LEO CDP is processing all profiles in the database. It takes several minutes for this job'
    		    	});
    			}
    			
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
       });
	}
	
    function initCustomerProfileList(encodedKeywords) {
    	// Date Range Filtering Controller
    	initDateFilterComponent(false, null, null, 180);
    	$("#profile_filter_inputs > input.form-control").on('keyup', function (e) {
    	    if (e.key === 'Enter' || e.keyCode === 13) {
    	        // press enter key to update profile list 
    	    	doProfileListing();
    	    }
    	});
    	
    	// journey map
    	loadJourneyMapList(false, function(id){
    		currentJourneyMapId = id;
        },true);
    	
    	if(typeof encodedKeywords === 'string' ) {
    		var nameToSearch = Base64.decode(encodedKeywords);
    		document.title = "Customer Data Hub - profile search by name: " + nameToSearch;
    		$('#filterName').val(nameToSearch);
    		$('#main_search_profile').val(nameToSearch);
    		$('#profile_filter_inputs > .form-control, #profile_filter_input_label').hide();
    		toggleProfileDisableDateFilter(true);
    	} 
    	else {
    		$('#profile_filter_inputs > input:first').show();
    	}
    	
    	var tableDomSel = "#profile_list_table";
    	var loaderDomSel = "#profile_list_loader";
    	var containerDomSel = "#profile_list";
    	
    	var profileFilterParams = function(d) {
    		var checked = $('#disable_date_filter:checked').length === 1;
            if( ! checked ) {
             	var datetimeFilter = getDateFilterValues();
                d.beginFilterDate = datetimeFilter.beginFilterDate;
     			d.endFilterDate = datetimeFilter.endFilterDate;
            }
    			
            d.journeyMapId = currentJourneyMapId;
    		d.filterContactable = $('#filterOnlyContactable:checked').length > 0;
    		d.email = $('#filterEmail').val().trim();
    		d.phone = $('#filterPhone').val().trim();
    		d.visitorId = $('#filterByVisitorId').val().trim();
    		d.profileId = $('#filterByProfileId').val().trim();
    		d.lastTouchpointName = $('#filterByLastTouchpoint').val().trim();
    		d.dataLabel = $('#filterByDataLabel').val().trim();
    		d.authorizedViewer = $('#filterByAuthorizedViewer').val().trim();
    		d.authorizedEditor = $('#filterByAuthorizedEditor').val().trim();
    		
    		var statusStr = $('#filterProfileListByStatus').val().trim();
    		d.status = parseInt(statusStr === "" ? 1 : statusStr);
    		
    		var name =  $('#filterName').val();
    		if(name.length >= 2 ){
    			d.name = name;
    		}
    		return d;
    	}
    	
    	var loadDataCallback = function(json) {
    		
     		if( ! $(tableDomSel).data('canInsertData') ){
 				$('button.data-control-insert').attr('disabled','disabled');
 			}
     		if( ! $(tableDomSel).data('canEditData') ){
 				$('button.data-control-update').attr('disabled','disabled');
 			}
    	}
    	profileListTable = loadProfileListByFilter(containerDomSel, loaderDomSel, tableDomSel, profileFilterParams, loadDataCallback);
    }   

</script>