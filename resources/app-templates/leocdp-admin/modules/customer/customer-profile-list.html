<!-- customer data profile list  -->
<style>
	.has_contact {
		background-color: #FFF8DC!important;
		color: #3300ff!important;
		font-size:14px!important;
		font-weight: bold;
	}
	.no_contact {
		color:#000!important;
	}
	th.sorting, th.sorting_desc, th.sorting_asc {
		text-decoration: underline;
	}
	#profile_filter_input_label{
		margin-top:10px;
	}
	div.profile_medium_score {
		color:#1A529E!important;font-size:14px!important;
	}
	div.profile_high_score {
		color:#3300ff!important;font-size:16px!important;
	}
</style>
<div class="row">
    <div class="col-lg-6">
        <h5 class="page-header" id="page_breadcrumb" > </h5>
    </div>
    <div class="col-lg-6 text-right" style="padding: 10px">
    	<button type="button" class="btn btn-do-now" onclick="location.reload()" title="Refresh Profile List" > 
    		<i class="fa fa-refresh" aria-hidden="true"></i> Refresh
    	</button>
    	<button type="button" class="btn btn-info data-control-update" onclick="mergeDuplicatesHandler()" title="Merge duplicated profiles into a single profile" > 
    		<i class="fa fa-compress" aria-hidden="true"></i> Deduplicate
    	</button>
    	<button type="button" class="btn btn-primary data-control-update" onclick="importProfileHandler()" title="Import Profiles" > 
    		<i class="fa fa-cloud-upload" aria-hidden="true"></i> Import Data
    	</button>
    	<button type="button" class="btn btn-goto-router data-control-insert" onclick="newProfileHandler()" title="New Profile Editor"> 
    		<i class="fa fa-plus-circle" aria-hidden="true"></i> New Profile 
    	</button>
    </div>
</div>
    
<div class="top_page_header" >
	<h4> <i class="fa fa-users" aria-hidden="true"></i> Profile Data Management </h4>
</div>

<div id="profile_list_loader" class="loader"></div>

<div id="profile_list" style="display: none;" >		
	<div class="panel panel-info" >
	   	<div class="panel-heading">
	   		<b> <i class="fa fa-search" aria-hidden="true"></i> Data Query Filter </b>
	   	</div>
	    <div class="panel-body">
	      	<div class="col-md-12 row">
				<div class="col-md-6" style="background-color:#f5f5f5; border-radius: 5px;padding-top: 5px"> 
					<div id="filterByJourneyMap" class="col-md-12" style="padding-bottom: 10px" >
      					<select id="journeyMapList" class="form-control" data-placeholder="Choose an Journey Map" class="select" > </select>
			  		</div>
					<div class="col-md-12">
						<label title="Filter all profiles that have mobile phone or email" > 
								<input id="filterOnlyContactable" type="checkbox" onchange="filterOnlyContactableProfiles(this)" > Filter contact profiles  
						</label>
					</div> 
					<div class="col-md-12">
						<label title="Filter all profiles within the specified date range"> 
							<input id="disable_date_filter" type="checkbox" onclick="toggleProfileDisableDateFilter(false)" > Turn off date filter 
						</label>
						
					</div> 
					<div class="col-md-12">
						<div id='beginFilterDateHolder' class="col-md-6"> 
							<div class="form-group">
				            	<b>Since the updated date </b>
				                <div class='input-group date' id='beginFilterDate'>
				                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
						<div id='endFilterDateHolder' class="col-md-6"> 
							<div class="form-group">
				           	 	<b> To the last updated date </b>
				                <div class='input-group date' id='endFilterDate'>
				                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
				                        <span class="glyphicon glyphicon-calendar"></span>
				                    </span>
				                </div>
				            </div>
						</div>
					</div>
					
				</div>
				<div class="col-md-6" > 
					<div class="col-md-6" >
						<div class="dropdown">
						    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Advanced Filter
						    <span class="caret"></span></button>
						    <ul class="dropdown-menu">
						    	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterByProfileId')" >Profile ID</a></li>
						    	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterByStatus')" >Profile Status</a></li>
						    	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterEmail')" >Primary Email</a></li>
						      	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterPhone')" >Primary Phone</a></li>
						      	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterByVisitorId')" >Web Visitor ID</a></li>
						      	<li><a href="javascript:" onclick="handleProfileFiltersBy(this,'#filterByLastTouchpoint')" >Last Touchpoint Name</a></li>
						    </ul>
						</div>
						<div id="profile_filter_inputs" >
							<label id="profile_filter_input_label">Profile Status</label>
							
							<input type="hidden" id="filterName" value="" >
							
							<input style="display: none;" type="text" class="form-control" id="filterByProfileId" placeholder="Enter profile ID" >
							<select class="form-control" id="filterByStatus" >
						    	<option value="">ACTIVE PROFILES</option>
						    	<option value="0">INACTIVE PROFILES</option>
						    	<option value="-1">INVALID PROFILES</option>
						    	<option value="-4">DELETED PROFILES</option>
						    </select>
							
							<input style="display: none;" type="text" class="form-control" id="filterEmail" placeholder="Enter email" >
							<input style="display: none;" type="text" class="form-control" id="filterPhone" placeholder="Enter phone number" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByVisitorId" placeholder="Enter web visitor ID" >
					  		<input style="display: none;" type="text" class="form-control" id="filterByLastTouchpoint" placeholder="Enter touchpoint name" >
					  		
						</div>
					</div>
					<div class="col-md-6" >
						<div class="col-md-12" style="padding-top:20px;">
							<div class="col-md-6" style="text-align: right;">
							 	<button type="button" class="btn btn-do-now" onclick="resetProfileSearch()" ><i class="fa fa-fw fa-undo"></i> Reset </button>
							</div>
							<div class="col-md-6" >
							 	<button type="button" class="btn btn-goto-router" onclick="doProfileListing()" ><i class="fa fa-fw fa-filter"></i> Filter </button>
							</div>
						</div>
					</div>
				</div>
			</div>
	    </div>
	</div>
    
	<div class="row gridholder">
	    <div class="col-lg-12">
	        <div class="table-responsive">
	        	
	            <table id="profile_list_table" class="display" style="width:100%;">
	                <thead>
	                    <tr>
	                        <th class="text-center" title="A profile that has mobile phone or email">Contact</th>
	                        <th >Full Name</th>
	                        <th class="text-center">Email</th>
	                        <th class="text-center">Phone</th>
	                        <th class="text-center">Last-seen Touchpoint</th>
	                        <th class="text-center">Data Quality</th>
	                        <th class="text-center">Lead Score</th>
	                        <th class="text-center">CLV Score</th>	                        
	                        <th class="text-center">Updated</th>
	                        <th class="text-center">Status</th>
	                        <th class="text-center">Actions</th>
	                    </tr>
	                </thead>
	            </table>
	        </div>
	    </div>
	</div>
</div>
    
<script>
	var canEditData = false, canDeleteData = false, canInsertData = false, dataTable = false;
	var currentJourneyMapId = "";
	
	function toggleProfileDisableDateFilter(disableBySearch) {
		var checked = $('#disable_date_filter:checked').length === 1;
		if(checked || disableBySearch === true) {
			$('#beginFilterDateHolder').hide();
			$('#endFilterDateHolder').hide();
			if(disableBySearch) {
				$('#disable_date_filter').prop('checked', true);
			}
		} else {
			$('#beginFilterDateHolder').show();
			$('#endFilterDateHolder').show();
			$('#disable_date_filter').prop('checked', false);
		}
	}
	
	function handleProfileFiltersBy(domNode, selector){
		$('#profile_filter_inputs > .form-control').val("").hide();
		$(selector).show();
		$('#profile_filter_input_label').text($(domNode).text()).show()
		$('#main_search_profile').val('');
	}
	
	function doProfileListing() {
		var keywords = $('#main_search_profile').val().trim();
    	if(keywords.length > 1){
    		var encodedString = Base64.encode(keywords);
    		location.hash = "calljs-leoCdpRouter('Customer_Profile_Search','" + encodedString + "')";
    	} 
    	$('#profile_list_table').DataTable().clear();
	    $('#profile_list_table').DataTable().ajax.reload();
	}
	
	function filterOnlyContactableProfiles(node){
		if($(node).prop('checked')) {
			toggleProfileDisableDateFilter(true);
		} 
	}
	
	function resetProfileSearch() {
		if(LeoCdpAdmin.routerKey === "Customer_Profile_Search" ){
			$('#main_search_profile').val('');
			location.hash = "calljs-leoCdpRouter('Profile_Management')";
		} else {
			$('#filterOnlyContactable').prop('checked', false);
			
			// reset filter data
			$('#filterEmail').val('');
			$('#filterPhone').val('');
			$('#filterByVisitorId').val('');
			$('#filterByProfileId').val('');
			$('#filterByLastTouchpoint').val('');
			$('#filterByStatus').val('');
			$('#filterName').val('');
			$('#journeyMapList').val("").change().trigger("chosen:updated");
			
			$('#main_search_profile').val('');
			$('#beginFilterDate > .form-control').show();
			$('#endFilterDate > .form-control').show();
			$('#disable_date_filter').prop('checked', false);
			doProfileListing();
		}
	}
	
	var newProfileHandler = function (){
		if(canInsertData){
			gotoLeoCdpRouter('Customer_Profile_Editor', 'new' );
		} else {
			errorNoAuthorization();
		}
	}
	
	var importProfileHandler = function(){
		location.hash = "calljs-leoCdpRouter('Customer_Profile_Import')";
	}
	
	var mergeDuplicatesCallback = function(){
		iziToast.success({
    	    title: 'Merge Duplicate Profile',
    	    onClosed: function(){
    	    	location.reload();
    	    },
    	    message: 'Data is merged successfully!'
    	});
	}
	
	var mergeDuplicatesHandler = function() {
		LeoAdminApiUtil.callPostAdminApi('/cdp/profiles/merge-duplicates', {'mergeStrategy' : 'automation'}, function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
    			if(json.data){
    				iziToast.info({
    		    	    title: 'Merge Duplicate Profile',
    		    	    message: 'LEO CDP is processing all profiles in the database. It takes several minutes for this job'
    		    	});
    			}
    			
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
       });
	}
	
    function initCustomerProfileList(encodedKeywords) {
    	// Date Range Filtering Controller
    	initDateFilterComponent();
    	$("#profile_filter_inputs > input.form-control").on('keyup', function (e) {
    	    if (e.key === 'Enter' || e.keyCode === 13) {
    	        // press enter key to update profile list 
    	    	doProfileListing();
    	    }
    	});
    	
    	// journey map
    	loadJourneyMapList(false, function(id){
    		currentJourneyMapId = id;
        },true);
    	
    	if(typeof encodedKeywords === 'string' ) {
    		var nameToSearch = Base64.decode(encodedKeywords);
    		document.title = "Customer Data Hub - profile search by name: " + nameToSearch;
    		$('#filterName').val(nameToSearch);
    		$('#main_search_profile').val(nameToSearch);
    		$('#profile_filter_inputs > .form-control, #profile_filter_input_label').hide();
    		toggleProfileDisableDateFilter(true);
    	} 
    	else {
    		$('#profile_filter_inputs > input:first').show();
    	}
    	
        var usersession = getUserSession();
        if (usersession) {
        	var tableSchema = [
                {
                    "data": "type" // 0
                },
                {
                    "data": "firstName" // 1
                },
                {
                    "data": "primaryEmail" // 2
                },
                {
                    "data": "primaryPhone" // 3
                },
                {
                    "data": "lastTouchpoint" // 4
                },
                {
                    "data": "dataQualityScore" // 5
                },
                {
                    "data": "totalLeadScore" // 6
                },
                {
                    "data": "totalCLV" // 7
                },                
                {
                    "data": "updatedAt" // 8
                },
                {
                    "data": "status" // 9
                }
            ];
        	
            dataTable = $('#profile_list_table').DataTable({
            	"lengthMenu": [[30, 50, 70], [30, 50, 70]],
            	'processing': true,
                'serverSide': true,
                'searching': false,
                'ordering': true,
                'serverMethod': 'POST',
                'ajax': {
                    url: baseLeoAdminUrl + '/cdp/profiles/filter',
                    contentType: 'application/json',
                    beforeSend: function (request) {
                    	$("#profile_list_loader").show();
                    	$("#profile_list").hide();
                        request.setRequestHeader("leouss", usersession);
                    },
                    data: function (d) {
                        // get data in DOM to build filtering params
                        var checked = $('#disable_date_filter:checked').length === 1;
                        if( ! checked ) {
                        	var datetimeFilter = getDateFilterValues();
                            d.beginFilterDate = datetimeFilter.beginFilterDate;
                			d.endFilterDate = datetimeFilter.endFilterDate;
                        }
            			
            			d.filterContactable = $('#filterOnlyContactable:checked').length > 0;
            			d.email = $('#filterEmail').val().trim();
            			d.phone = $('#filterPhone').val().trim();
            			d.visitorId = $('#filterByVisitorId').val().trim();
            			d.profileId = $('#filterByProfileId').val().trim();
            			d.lastTouchpointName = $('#filterByLastTouchpoint').val().trim();
            			d.journeyMapId = currentJourneyMapId;
            			
            			var statusStr = $('#filterByStatus').val().trim();
            			d.status = parseInt(statusStr === "" ? 1 : statusStr);
            			
            			var name =  $('#filterName').val();
            			if(name.length >= 2 ){
            				d.name = name;
            			}
            			
            			d.order.map(function(e){
            				e.field = tableSchema[e.column] ? tableSchema[e.column].data : "";
            			})
            			
                        return JSON.stringify(d);
                    },
                    dataSrc: function ( json ) {
                    	canInsertData = json.canInsertData;
            	    	canEditData = json.canEditData;
                		canDeleteData = json.canDeleteData;
                	
                		if( canInsertData === false || canEditData === false ){
            				$('button.data-control-insert').attr('disabled','disabled');
            				$('button.data-control-update').attr('disabled','disabled');
            			}
                		
                		// done, show UI
                		$("#profile_list_loader").hide();
                		$("#profile_list").show();
                		
                		return json.data;
                     }
                },
                'columnDefs': [
                    {
                        "render": function (data, type, row) {
                        	var hasContactInfo = (row.primaryEmail != '' || row.primaryPhone != '') && data > 0;
                        	var html = getCheckedBoxIcon(hasContactInfo);
                            return '<div class="datatable_text text-center" style="color:#41A317!important;font-size:13px!important" >' + html + '</div>';
                        },
                        "targets": 0,
                        "orderable": false
                    },
                    {
                        "render": function (data, type, row) {
                        	var name = 'Web Visitor';
                        	var cssClass = "datatable_text no_contact";
                        	if(row.firstName.length > 0 || row.lastName.length > 0){
                        		name = textTruncate(row.firstName + ' ' + row.lastName, 30);
                        		cssClass = " has_contact";
                        	}
                            var callJsViewStr = "#calljs-leoCdpRouter('Customer_Profile_Info','" + row.id + "')";
                            return '<a class="' + cssClass + '" title="Profile Report" href="' + callJsViewStr + '" >' + name + '</a>';
                        },
                        "targets": 1,
                        "orderable": false
                    },
                    {
                        "render": function (data, type, row) {
                        	//format email
                        	if(typeof data === 'string' ) {
                        		var callJsViewStr = "#calljs-leoCdpRouter('Customer_Profile_Info','" + row.id + "')";
                            	var link = '<a title="'+data+'" href="' + callJsViewStr + '" >' + textTruncate(data, 30) + '</a>';
                            	return '<div class="datatable_text ">'  + link + '</div>';
                        	}
                        	return '-';
                        },
                        "targets": 2,
                        "orderable": false
                    },
                    {
                        "render": function (data, type, row) {
                        	//format phone
                        	if(typeof data === 'string' ){
                        		var callJsViewStr = "#calljs-leoCdpRouter('Customer_Profile_Info','" + row.id + "')";
                            	var link = '<a title="'+data+'" href="' + callJsViewStr + '" >' + textTruncate(data, 30) +'</a>';
                            	return '<div class="datatable_text">'  + link + '</div>';
                        	}
                        	return '-';
                        },
                        "targets": 3,
                        "orderable": false
                    },
                    {
                        "render": function (data, type, row) {
                        	if(typeof row.lastTouchpoint !== "object") {
                        		row.lastTouchpoint = {"name":"No data"};
                        	}
                        	return '<div style="font-size:11.4px;" title="'+ row.lastTouchpoint.name +'">'  + textTruncate(row.lastTouchpoint.name, 45) + '</div>';
                        },
                        "targets": 4,
                        "orderable": false
                    },
                    {
                        "render": function (data, type, row) {
                        	var score =  new Number(data).toLocaleString();
                        	if( data <= 100  ) {
                        		return '<div class="datatable_text text-center">'  + score + ' </div>';
                        	}
                        	else if (data > 100 && data < 250) {
                        		return '<div class="highlight_text text-center profile_medium_score" >'  + score + '</div>';
                        	}
                        	else {
                        		return '<div class="highlight_text text-center profile_high_score"  >'  + score + '</div>';
                        	}
                        	return '<div class="datatable_text text-center">'  + score + ' </div>';
                        },
                        "targets": 5
                    },
                    {
                        "render": function (data, type, row) {
                        	var score =  new Number(data).toLocaleString();
                        	if(data < 20 ){
                        		return '<div class="datatable_text text-center">'  + score + ' </div>';
                        	}
                        	else if(data >= 20 && data < 100 ){
                        		return '<div class="highlight_text text-center profile_medium_score" >'  + score + '</div>';
                        	}
                        	else if(data >= 100){
                        		return '<div class="highlight_text text-center profile_high_score" >'  + score + '</div>';
                        	}
                        	return '<div class="highlight_text text-center" style="color:#404040!important;font-size:0.8em!important" >'  + score + ' </div>';
                        },
                        "targets": 6
                    },
                    {
                        "render": function (data, type, row) {
                        	var score =  new Number(data).toLocaleString();
                        	if(data < 20 ){
                        		return '<div class="datatable_text text-center">'  + score + ' </div>';
                        	}
                        	else if(data >= 20 && data < 100 ){
                        		return '<div class="highlight_text text-center profile_medium_score" >'  + score + '</div>';
                        	}
                        	else if(data >= 100){
                        		return '<div class="highlight_text text-center profile_high_score" >'  + score + ' </div>';
                        	}
                        	return '<div class="highlight_text text-center" style="color:#404040!important;font-size:0.8em!important" >'  + score + ' </div>';
                        },
                        "targets": 7
                    },
                    {
                        "render": function (data, type, row) {
                        	if(data){
                        		var date = moment.utc(data).local().format('YYYY-MM-DD HH:mm:ss');
                                return '<div class="small text-center" style="color:#3300ff;width:74px" >'  + date + '</div>';
                        	}
                        	return '-';
                        },
                        "targets": 8
                    },
                    {
                        "render": function (data, type, row) {
                        	var text = "ACTIVE";
                        	if(data === 0) {
                        		text = "INACTIVE";
                        	}
                        	else if(data === -1) {
                        		text = "INVALID";
                        	}
                        	else if(data === -4) {
                        		text = "DELETED";
                        	}
                        	return '<div class="small text-center" style="color:#3300ff!important" title="The profile status is '+ text +'">'  + text + '</div>';
                        },
                        "targets": 9
                    },
                    {
                        "render": function (data, type, row) {
                        	var callJsViewStr = "#calljs-leoCdpRouter('Customer_Profile_Info','" + row.id + "')";
                            var html = '<a class="control" title="Profile Report" href="' + callJsViewStr + '" > <i class="fa fa-info-circle" aria-hidden="true"></i> View</a>';
                        	if( canEditData ){
                        		var callJsEditStr = "#calljs-leoCdpRouter('Customer_Profile_Editor','" + row.id + "')";
                        		html += ' <br><a class="control" title="Profile Editor" href="' + callJsEditStr + '" > <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit</a>';
                        	}
                            return html;
                        },
                        "targets": 10
                    }
                ],
                'columns': tableSchema,
                
                // sort by the updated datetime of profile
                'order': [[8, 'desc']]
            });
        }
    }    
</script>