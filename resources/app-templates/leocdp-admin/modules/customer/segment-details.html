
<!-- Segment Details -->
<style>
	.form-group .sm_purpose {
		margin: 5px 0;
		background-color: #e5e6e5;
		padding: 7px;
		border-radius: 7px;
	}
	.sm_purpose b i.fa {
		font-size:1.2em!important;
		color: #3300ff!important;
	}
	.sm_purpose b {
		color: #000!important;
		font-size: 1.1em!important;
		font-weight: bold!important;
	}
	.sm_purpose button {
		margin-left: 10px;
		float: right;
	}
	#segment_disable_date_filter_holder {
		font-size: 18px;
	}
	#panel_segment_data_personalization .highlight_box {
		background-color: #e8e8e8!important;
    	border-radius: 10px!important;;
		padding: 8px 8px 34px 8px!important;
	}
	input.url_holder {
		background-color: #FFF8DC!important;
	}
	div.segment_download_link {
		float: right; padding-top: 5px; font-weight: bold; font-size: 15px;
	}
	.rule-container .rule-value-container:last-child {
	  	min-width: 320px;
	}
	.rule-container .rule-value-container:last-child input{
	  	width: 100%;
	}
</style>

<div class="row">
	<div class="col-lg-8">
		<h5 class="page-header" id="page_breadcrumb" > </h5>
	</div>
	<div class="col-lg-4 text-right" style="padding: 10px">
		<button type="button" class="btn btn-info" title="Go back" onclick="history.back()" > 
			<i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Back 
		</button>
		<button type="button" class="btn btn-do-now" onclick="location.reload()" title="Refresh data"  > 
       		<i class="fa fa-refresh" aria-hidden="true"></i> Refresh
       	</button>
		<button type="button" class="btn btn-danger data-control-delete" title="Delete this segment" > 
			<i class="fa fa-trash" aria-hidden="true"></i> Delete 
		</button>
		<button type="button" class="btn btn-goto-router data-control-edit" title="Edit this segment" > 
			<i class="fa fa-pencil-square-o" aria-hidden="true"></i> Edit 
		</button>
	</div>
</div>

<div id="segment_details_loader" class="loader"></div>

<div id="segment_details_div" style="display: none;" >
	<!-- metadata  -->
	<ul class="list-group">
		<li class="list-group-item ">
	  		<b>Index score in activation:</b> <span id="sm_indexScore" class="highlight_text" ></span>
	  	</li>
	  	<li class="list-group-item ">
	 		<b>Segment Name:</b> <span id="sm_name" class="highlight_text"></span>
	  	</li>
	  	<li class="list-group-item ">
	  		<b>Description:</b> <span id="sm_description" class="highlight_text" ></span>
	  	</li>
	  	<li class="list-group-item ">
	  		<b>Authorized users can view data:</b> <span id="sm_authorizedViewers" class="highlight_text"></span>
	  	</li>
	  	<li class="list-group-item ">
	  		<b>Authorized users can update data:</b> <span id="sm_authorizedEditors" class="highlight_text" ></span>
	  	</li>
   	</ul>
	
	<div class="panel-group">
	
		<!--  Tab Navigation Items -->
	    <ul class="nav nav-tabs" data-tab-content="segment_info_tabs" >
			<li class="active" >
				<a href="javascript:" data-target-tab="panel_segment_report_and_profiles" title="Segment Event Report" > <i class="fa fa-line-chart" aria-hidden="true"></i> Report and Profiles</a>
	       	</li>
	       	<li>
				<a href="javascript:" data-target-tab="panel_segment_query_details" title="Data Query Rule Details" > <i class="fa fa-filter" aria-hidden="true"></i> Data Query Rules </a>
	       	</li>
	       	<li>
				<a href="javascript:" data-target-tab="panel_segment_data_exporting" title="Data Exporting" > <i class="fa fa-download" aria-hidden="true"></i> Data Exporting </a>
	       	</li>
	       	<li>
				<a href="javascript:" data-target-tab="panel_segment_data_connection" title="Data Connection" > <i class="fa fa-exchange" aria-hidden="true"></i> Data Connection </a>
	       	</li>
	       	<li id="segment_data_personalization" style="display: none;">
				<a href="javascript:" data-target-tab="panel_segment_data_personalization" title="Data Personalization" > <i class="fa fa-smile-o" aria-hidden="true"></i> Data Personalization </a>
	       	</li>
	       	<li style="display: ;">
				<a href="javascript:" data-target-tab="panel_segment_data_activation" title="Data Activation" > <i class="fa fa-random" aria-hidden="true"></i> Data Activation </a>
	       	</li>
	  	</ul>
	  	
	  	<!-- Tab Contents  -->
	    <div id="segment_info_tabs" class="tab-content" style="min-height: 750px;"  >
	    	
	    	<!-- tab 1 Event Report  -->
			<div class="tab-pane active" id="panel_segment_report_and_profiles" >
				<div class="panel panel-leoadmin">
					<div class="panel-heading"> <b> <i class="fa fa-line-chart" aria-hidden="true"></i> 
						 Event Data Report <span id="eventDataFromDate" class="highlight_text">  </span> 
										<i class="fa fa-arrow-right" aria-hidden="true"></i> <span id="eventDataToDate" class="highlight_text" > </span> </b> 
					</div>
					<div class="panel-body row">
						<div class="col-lg-9">
							<div class="row float-right">
						        <div class='col-lg-5 col-xs-12'>
						            <div class="form-group">
						                <div class='input-group date' id='beginFilterDate'>
						                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
						                        <span class="glyphicon glyphicon-calendar"></span>
						                    </span>
						                </div>
						            </div>
						        </div>
						        <div class='col-lg-5 col-xs-12'>
						            <div class="form-group">
						                <div class='input-group date' id='endFilterDate'>
						                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
						                        <span class="glyphicon glyphicon-calendar"></span>
						                    </span>
						                </div>
						            </div>
						        </div>
						        <div class='col-lg-2 col-xs-12 text-center'>
						        	<button type="button" class="btn btn-primary" style="width: 110px" onclick="loadSegmentEventReport(true)" > 
						        		<i class="fa fa-check" aria-hidden="true"></i> Refresh </button>
						        </div>
						    </div>
							<div class="highlight_box">
				      			
				      			<canvas id="segmentEventChart"></canvas>
				      		</div>
						</div>
						<div class="col-lg-3 text-center">
							<div id="segment_size_chart" style="max-width: 300px; margin: 70px auto; "></div>
						</div>
					</div>
				</div>
				
				<div class="panel panel-leoadmin" id="profile-list-panel"  >
					<div class="panel-heading">
						<div class="row"> 
							<div class="col-lg-12">
			                      <b> <i class="fa fa-list-ul" aria-hidden="true"></i> <label> All Matched Profiles </label> </b>                     
			                </div>
		                </div> 
					</div>
					<div class="panel-body row">
						<div class="table-responsive" id="profilelist_holder" style="display: none;">
						 	<table id="profile_list_querybuilder" class="display" style="width:100%;">
						    	<thead>
						        	<tr>
							            <th>Full Name</th>
							            <th>Age</th>
							            <th>Gender</th>
							            <th>Primary Email</th>
							            <th>Data Quality</th>
							            <th>Funnel Stage</th>
							            <th>Last Updated at</th>
							            <th>Last-seen Touchpoint</th>
						        	</tr>
						    	</thead>
						 	</table>
						</div>
					</div>
				</div>
			</div>
			
			<!-- tab 2 Query Details  -->
			<div class="tab-pane" id="panel_segment_query_details" >
				<div class="panel panel-leoadmin">
					<div class="panel-heading"> <b> <i class="fa fa-filter" aria-hidden="true"></i> Data Query Rules </b> </div>
					<div class="panel-body row">
						
						<div id="segment_disable_date_filter_holder" class='col-lg-9 text-center' >
							<span id='beginFilterDate'> </span>
							<i class="fa fa-long-arrow-right" aria-hidden="true" style="font-weight: bold;" ></i>
							<span  id='endFilterDate'> </span>
						</div>
						
						<div class="col-lg-12">
							<div id="segment-builder-holder"></div>
						</div>
						
					</div>
				</div>
			</div>
			
			<!-- tab 3 Data Exporting  -->
			<div class="tab-pane" id="panel_segment_data_exporting" >
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Total Profile Count </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<b class="segment_size" >0</b>
		     		</div>
				</div>
				
				<div class="form-group" >

					<div class="col-sm-12 sm_purpose" > 
						<div class="col-sm-10" >
							<label class="label_box" > <i class="fa fa-file-excel-o" aria-hidden="true"></i> 
								Export CSV data, the file is formated for Excel or Google Sheets (The URL is valid in 15 minutes)</label>
							<input type="text" class="form-control url_holder" id="txt_exported_excel_csv" readonly placeholder="URL to download CSV data for Excel / Google Sheets" >
						</div>
						<div class="col-sm-2" >
							<button type="button" class="btn btn-do-now" id="btn_exported_excel_csv" style="margin-top:10px;" onclick="getSegmentDownloadUrl(this,'txt_exported_excel_csv')" > 
								<i class="fa fa-check" aria-hidden="true"></i> Generate & Copy URL 
							</button>
							<div class="segment_download_link" >
								<a id="ahref_exported_excel_csv" style="display: none;" target="_blank" > Click here to download </a>
							</div>
						</div>
					</div>
					
					<div class="col-sm-12 sm_purpose" > 
						<div class="col-sm-10" >
							<label class="label_box" > <i class="fa fa-facebook-official" aria-hidden="true"></i> 
								Export CSV data, the file is formated for Facebook Custom Audience (The URL is valid in 15 minutes) </label>
							<input type="text" class="form-control url_holder" id="txt_exported_facebook_csv" readonly placeholder="URL to download CSV data for Facebook Custom Audience" >
						</div>
						<div class="col-sm-2" >
							<button type="button" class="btn btn-do-now" id="btn_exported_facebook_csv" style="margin-top:10px;" onclick="getSegmentDownloadUrl(this,'txt_exported_facebook_csv')"> 
								<i class="fa fa-check" aria-hidden="true"></i> Generate & Copy URL 
							</button>
							<div class="segment_download_link">
								<a id="ahref_exported_facebook_csv" style="display: none;" target="_blank" > Click here to download </a>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<!-- tab 4 Data Connection  -->
			<div class="tab-pane" id="panel_segment_data_connection" >
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Total Profile Count </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<b class="segment_size" >0</b>
		     		</div>
				</div>		
				
				<div class="form-group" >
					<div class="col-sm-12 sm_purpose" > 
						<div class="col-sm-10" >
							<label class="label_box" > <i class="fa fa-exchange" aria-hidden="true"></i> 
							Secured URL connection for raw JSON data (The URL is valid in 15 minutes) </label>
							<input type="text" class="form-control url_holder" id="segment_json_url" readonly placeholder="URL for JSON data connection" >
						</div>
						<div class="col-sm-2" >
							<button type="button" class="btn btn-do-now" title="" onclick="getSecuredDataJson()" id="btn_segment_json_url" style="margin-top:10px;"> 
								<i class="fa fa-check" aria-hidden="true"></i> Generate & Copy URL 
							</button>
						</div>
					</div>
				</div>	
				
				<div class="form-group" >
					<div class="col-sm-12 sm_purpose" > 
						<div class="col-sm-10" >
							<label class="label_box" > <i class="fa fa-exchange" aria-hidden="true"></i> 
							Secured URL connection for raw CSV data (The URL is valid in 15 minutes) </label>
							<input type="text" class="form-control url_holder" id="segment_csv_url" readonly placeholder="URL for CSV data connection" >
						</div>
						<div class="col-sm-2" >
							<button type="button" class="btn btn-do-now" title="" onclick="getSecuredDataCsv()" id="btn_segment_csv_url" style="margin-top:10px;"> 
								<i class="fa fa-check" aria-hidden="true"></i> Generate & Copy URL 
							</button>
						</div>
					</div>
				</div>
					
			</div>
			
			<!-- tab 5 Data Personalization  -->
			<div class="tab-pane" id="panel_segment_data_personalization" >
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Total Profile Count </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<b  class="segment_size" >0</b>
		     		</div>
				</div>
				
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> Digital asset category </label>
		     		</div>
		     		<div class="col-lg-7" id="assetCategoryHolder" >
		     			<label class="radio-inline"><input type="radio" name="assetCategory" value="product" checked="checked" > Product Data Asset</label>
		     			<label class="radio-inline" style="display: none;" ><input type="radio" name="assetCategory" value="content" disabled > Content Data Asset</label>
		     		</div>
				</div>
				
				<div class="form-group highlight_box" >
					<div class="col-lg-5">
	                	<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> Priority group for matched profiles </label>
	                </div>
		     		<div class="col-lg-7"  >
		                <select id="priorityGroupSelector" data-placeholder="Choose a group name" class="select" >
		                  	<!-- priorityGroupSelector -->  
		                </select>
	                </div>
	            </div>
	            
	            <div class="form-group text-right" >
	            	<button type="button" class="btn btn-do-now" onclick="doSetItemsToRecommenderSystem()"><i class="fa fa-check" aria-hidden="true"></i> Run Personalization Engine </button>
	            </div>
			</div>
			
			<!-- tab 6 Data Activation  -->
			<div class="tab-pane" id="panel_segment_data_activation" >
			 	<div class="panel panel-leoadmin" >
					
					<div class="panel-body row">
						<div class="col-lg-12 ">
						
							<div class="panel panel-default">
							    <div class="panel-heading collapse-panel-heading active" role="tab" id="activationPlanHeader">
							      <h4 class="panel-title">
							        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#activationPlan" aria-expanded="false" aria-controls="activationPlan">
							          <i class="fa fa-info-circle" aria-hidden="true"></i> Activation Purpose
							        </a>
							      </h4>
							    </div>
							    <div id="activationPlan" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="activationPlanHeader">
							      <div class="panel-body">
								      <div class="form-group" id="segment_purposes" >
											<div class="col-sm-12 sm_purpose" id="sm_for3rdSynchronization" style="display: none;" > 
												<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> 
												To synchronize customer data into external systems using connectors </label>
												<button type="button" class="btn btn-do-now" title="Data Activation for connection and synchronization" data-purpose="for3rdSynchronization" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
	
											<div class="col-sm-12 sm_purpose" id="sm_forDeepAnalytics" style="display: none;"> 
												<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i>
												To do deep data analytics with Jupyter Notebook or Google Colab </label>
												<button type="button" class="btn btn-do-now" title="Data Activation for Deep Analytics " data-purpose="forDeepAnalytics" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
											
											<div class="col-sm-12 sm_purpose" id="sm_forPredictiveAnalytics" style="display: none;" > 
												<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i>
												To do predictive analytics with Jupyter Notebook or Google Colab </label>
												<button type="button" class="btn btn-do-now" title="Data Activation" data-purpose="forPredictiveAnalytics" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
										
											<div class="col-sm-12 sm_purpose" id="sm_forEmailMarketing" style="display: none;" > 
												<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i>
												To run email marketing campaign with personalized information </label>
												<button type="button" class="btn btn-do-now" title="Data Activation for Email Marketing" data-purpose="forEmailMarketing" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
											
											<div class="col-sm-12 sm_purpose" id="sm_forRealtimeMarketing" style="display: none;" > 
												<b> <i class="fa fa-info-circle" aria-hidden="true"></i> To push SMS or message notification for real-time marketing campaign </b>
												<button type="button" class="btn btn-do-now" title="Data Activation for Realtime Marketing" data-purpose="forRealtimeMarketing" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
											
											<div class="col-sm-12 sm_purpose" id="sm_forReTargeting" style="display: none;"> 
												<b> <i class="fa fa-info-circle" aria-hidden="true"></i> To run re-targeting advertising or remarketing campaign </b>
												<button type="button" class="btn btn-do-now" title="Data Activation for Re-Targeting" data-purpose="forReTargeting" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
											
											<div class="col-sm-12 sm_purpose" id="sm_forLookalikeTargeting" style="display: none;"> 
												<b> <i class="fa fa-info-circle" aria-hidden="true"></i> To run look-alike advertising campaign </b>
												<button type="button" class="btn btn-do-now" title="Data Activation for Lookalike-Targeting" data-purpose="forLookalikeTargeting" > 
													<i class="fa fa-check" aria-hidden="true"></i> Activate 
												</button>
											</div>
									 </div>
							      </div>
							    </div>
							</div>
							
							<div class="panel panel-default" style="display: none;">
							    <div class="panel-heading collapse-panel-heading active" role="tab" id="workingPlanHeader">
							      <h4 class="panel-title">
							        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#workingPlan" aria-expanded="false" aria-controls="workingPlan">
							          <i class="fa fa-info-circle" aria-hidden="true"></i> Activation Plan 
							        </a>
							      </h4>
							    </div>
							    <div id="workingPlan" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="workingPlanHeader">
							    	<div class="panel-body">
							      	 	<div class="table-responsive">
								         	<div id="activation_plan_table"></div>
								     	</div>
									 	<div id="sm_no_activation_plan" style="display: none;" > 
											<div class="alert alert-info" role="alert" style="padding: 10px">
												This segment has no any activation plan ! 
											</div>
									 	</div>
							      	</div>
							    </div>
							</div>
							
						</div>
		
					</div>
				</div>
			</div>
			
			
	    </div>
	</div>
</div>


<script>
	var segmentDataModel = false;
	var segmentDataStats = false;
	
	var initSegmentDetails = function(id) {
		// init UI tab
		setupTabPanels();
		setupCollapsePanels();
		
		// init date filter
		initDateFilterComponent(true, null, null, 30);
		
		// Date Range Filtering Controller
		var urlStr = baseLeoAdminUrl + '/cdp/segment/load';
        LeoAdminApiUtil.callPostAdminApi(urlStr, { 'id': id }, function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
        		// only super-admin role can remove the segment 
        		var behavioralEventMap = json.data.behavioralEventMap;
        		segmentDataModel = json.data.segmentData;
        		segmentDataStats = json.data.segmentStats;
                var segmentId = segmentDataModel.id;
                var managedBySystem = segmentDataModel.managedBySystem;
                var jsonQueryRules = JSON.parse( segmentDataModel.jsonQueryRules );
                
                document.title = 'Segment Details - ' + segmentDataModel.name;
        		
           	 	if(managedBySystem){
                	$('button.data-control-delete').attr('disabled','disabled');
                	$('button.data-control-delete').attr('title','Can not delete this segment, which is managed by system');
                }
                else {
                	if( json.canDeleteData){
            			$('button.data-control-delete').click(deleteSegment);
        			} else {
        				$('button.data-control-delete').attr('disabled','disabled');
        			}
                }
        		
        		if( json.canEditData ){
        			$('button.data-control-edit').click(function(){
        				location.hash = "calljs-leoCdpRouter('Segment_Builder','" + id + "')";
        			});
        		} else {
        			$('button.data-control-edit').attr('disabled','disabled');
        		}
                
        		// init UI after setting data into DOM 
        		
        		// segment event report
        		loadSegmentEventReport();
        		
        		// 
                setupSegmentDataAndReports(segmentDataModel)
                
                //
                setupSegmentPurposesActivation(segmentDataModel)

  				// Activation Plan
                loadActivationPlanTable(segmentDataModel.allActivationRules);
                
                // Segment Query Builder
                loadSegmentBuilder(behavioralEventMap, jsonQueryRules, true, false);
                
                // load profile list table
                loadProfilesInSegment();
                
                // show UI
                $('#profilelist_holder').show();
                $("#segment_details_div").show();
                $("#segment_details_loader").hide();
                
             	// Segment Statistics
                loadSegmentStatistics(segmentDataStats);
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
        });
	}
	
	 
	var getSecuredDataJson = function(){
		var buttonSelector =  "#btn_segment_json_url";
		
		var generatingUrl = function(){
			iziToast.info({ timeout : 2000, message: 'LEO CDP is processing data for the segment "'+segmentDataModel.name +'"' });
			
			var paramObj = { 'segmentId': segmentDataModel.id };
	        var url = window.baseLeoAdminUrl + '/cdp/segment/export-json';
	        LeoAdminApiUtil.getSecuredData(url, paramObj, function (json) {
	            if (json.httpCode === 0 && json.errorMessage === '' && json.data) {
	               	var securedJsonUrl = window.baseLeoAdminUrl + json.data ;
	               	$('#segment_json_url').val(securedJsonUrl);
	               	$(buttonSelector).data("url",securedJsonUrl);
	        		
	               	setTimeout(function(){  $(buttonSelector).data("init-done",true).trigger('click') }, 100);
	            }
	        });
		}
		
		if(mapClipboardJS[buttonSelector] == null){
			mapClipboardJS[buttonSelector] = true;
			
			generatingUrl();
    		new ClipboardJS(buttonSelector, {
     		    text: function(trigger) {
     		    	if( $(buttonSelector).data("init-done") ) {
     		    		notifySuccessMessage("Successfully copied URL into clipboard!");
     		    	}
     		        return $(buttonSelector).data("url");
     		    }
     		})
     	}
	}
	
	var getSecuredDataCsv = function(){
		var buttonSelector =  "#btn_segment_csv_url";
		
		var generatingUrl = function(){
			iziToast.info({ timeout : 2000, message: 'LEO CDP is processing data for the segment "'+segmentDataModel.name +'"' });
			
			var paramObj = { 'segmentId': segmentDataModel.id, 'csvType': 0 };
	        var url = window.baseLeoAdminUrl + '/cdp/segment/export-csv';
	        LeoAdminApiUtil.getSecuredData(url, paramObj, function (json) {
	            if (json.httpCode === 0 && json.errorMessage === '' && json.data) {
	               	var securedJsonUrl = window.baseLeoAdminUrl + json.data ;
	               	$('#segment_csv_url').val(securedJsonUrl);
	               	$(buttonSelector).data("url",securedJsonUrl);
	        		
	               	setTimeout(function(){  $(buttonSelector).data("init-done",true).trigger('click') }, 100);
	            }
	        });
		}
		
		if(mapClipboardJS[buttonSelector] == null){
			mapClipboardJS[buttonSelector] = true;
			
			generatingUrl();
    		new ClipboardJS(buttonSelector, {
     		    text: function(trigger) {
     		    	if( $(buttonSelector).data("init-done") ) {
     		    		notifySuccessMessage("Successfully copied URL into clipboard!");
     		    	}
     		        return $(buttonSelector).data("url");
     		    }
     		})
     	}
	}
	
	var getSegmentDownloadUrl = function(node, dataFor){
		var buttonSelector = "#"+$(node).attr('id');
		var csvType = 0; var aSel = "";

		if(dataFor === "txt_exported_excel_csv") {
			csvType = 0;
			aSel = "#ahref_exported_excel_csv";
		}
		else if(dataFor === "txt_exported_facebook_csv") {
			csvType = 1;
			aSel = "#ahref_exported_facebook_csv";
		}
		
		var generatingUrl = function(){
			// noti
			iziToast.info({ timeout : 2000, message: 'LEO CDP is processing data for the segment "'+segmentDataModel.name +'"' });
			var paramObj = { 'segmentId': segmentDataModel.id, 'csvType': csvType };
	        var url = window.baseLeoAdminUrl + '/cdp/segment/export-csv';
	        LeoAdminApiUtil.getSecuredData(url, paramObj, function (json) {
	            if (json.httpCode === 0 && json.errorMessage === '' && json.data) {
	               var url = window.baseLeoAdminUrl + json.data ;
	              
	               $('#' + dataFor).val(url);
	           	   $(buttonSelector).data("url",url);
	           	   $(aSel).attr("href",url).show();
	               
	           	   setTimeout(function(){  
	           		   $(buttonSelector).data("init-done",true).trigger('click') 
	           	   }, 100);

	            }
	        });
		}
		
		if(mapClipboardJS[buttonSelector] == null){
			mapClipboardJS[buttonSelector] = true;
			
			generatingUrl();
    		new ClipboardJS(buttonSelector, {
     		    text: function(trigger) {
     		    	if( $(buttonSelector).data("init-done") ) {
     		    		notifySuccessMessage("Successfully copied URL into clipboard!");
     		    	}
     		    	return $(buttonSelector).data("url");
     		    }
     		})
     	}
	}
	
	function removeActivationRuleForSegment(node){
		var id = $(node).data("activation-rule-id");
		alert("delete " + id)
	}
	
	var initActivationJsGridPlugin = function() {
		var ActivationButtons = function(config) {
		    jsGrid.Field.call(this, config);
		};
		ActivationButtons.prototype = new jsGrid.Field({
		    sorter: function(date1, date2) {
		        return 0;
		    },
		
		    itemTemplate: function(activationRuleId) {
		    	console.log("activationRuleId ", activationRuleId)
		    	var btnHtml = '<button type="button" class="btn btn-danger btn-sm" onclick="removeActivationRuleForSegment(this)"';
		    	btnHtml += (' data-activation-rule-id="' + activationRuleId  + '" ' );
		    	btnHtml += '><i class="fa fa-trash" style="font-size:1.2em" aria-hidden="true"></i> Remove </button>';
		    	return btnHtml;
		    },
		    
		    insertTemplate: function(value) {
	            return this._insertCode = value;
	        },

	        editTemplate: function(value) {
	            return this._editCode = value;
	        },

	        insertValue: function() {
	            return this._insertCode;
	        },

	        editValue: function() {
	            return this._editCode;
	        }
		});
		jsGrid.fields.ActivationButtons = ActivationButtons;
	}
	
	function loadActivationPlanTable(dataList){
		//
		dataList.forEach(function(e){
			e.action = e.actions.join("-")
		});
		//
		initActivationJsGridPlugin();
		$("#activation_plan_table").jsGrid({
   		    width: "100%",
   		    height: "auto",
   		    inserting: false,
   		    editing: false,
   		    sorting: false,
   		    paging: false,
   		    data: dataList,
   		    fields: [
   		    	{ name: "activationType", title : "Activation Type", type: "BoldText", width: 120, align: "center" },
   		        { name: "action", title : "Action", type: "text", width: 70, align: "center" },
   		     	{ name: "dataConnectorName", title : "Data Connector", type: "text", align: "center" },
   		        { name: "assetTemplateName", title : "Asset Template", type: "text", align: "center" },
   		     	{ name: "priority", title : "Priority", type: "number", width: 30, align: "center" },
   		        { name: "schedulingTime", title : "Scheduling Time", type: "number", width: 64, align: "center" },
   		     	{ name: "id", title : "Actions", type: "ActivationButtons", width: 50, align: "center"}
   		    ]
   		});  
	}
	
	window.segmentEventChart = false;
    var loadSegmentEventReport = function(refresh){
    		
    	var formatDate = 'YYYY-MM-DD HH:mm:ss';
    	var params = getDateFilterValues();
    	params["segmentId"] = segmentDataModel.id;
    	
    	var beginReportDate = params.beginFilterDate;
    	$('#eventDataFromDate').text(new moment(beginReportDate).format(formatDate))
    	
    	var endReportDate = params.endFilterDate;
    	$('#eventDataToDate').text(new moment(endReportDate).format(formatDate))
        
    	var urlStr = baseLeoAdminUrl + '/cdp/analytics360/event-report/segment';
    	
    	LeoAdminApiUtil.getSecuredData(urlStr, params , function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
	    		// 3) render chart data
	    		var chartId = 'segmentEventChart';
	    		if(refresh === true && segmentEventChart !== false){
	    			renderTimeseriesChart(chartId, json.data , true, segmentEventChart);
	    		}
	    		else {
	    			window.segmentEventChart = renderTimeseriesChart(chartId, json.data , false);
	    		}		   		
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
        });
    }
	
	var setupSegmentPurposesActivation = function(segmentData) {
		var segmentId = segmentData.id;
		var name = segmentData.name;
		var size = segmentData.totalCount;
		
		$('button[data-purpose]').click(function(){
			var purpose = $(this).data("purpose");
			if(purpose === "forEmailMarketing"){
				showEmailMarketingDialog(segmentId, name, size)
			}
			else if(purpose === "for3rdSynchronization"){
				showDataSynchronizationDialog(segmentId, name, size)
			}
			else {
				// window.open("https://colab.research.google.com/notebooks/","_blank")
				iziToast.info({
		    	    title: 'Information',
		    	    message: 'This function is under development and is not yet available'
		    	});
			}
		})
	}
	
	var getHtmlForAuthorizedUserLogin = function(users) {
		var html = '';
		users.forEach(function(e){
			if(currentUserProfile.role === 6) {
				var callJsViewStr = "#calljs-leoCdpRouter('User_Login_Report','" + e + "')";
			    html += ('<a title="User Login Report" href="' + callJsViewStr + '" >'+e+'</a>, ');
			}
			else {
				html += (e + ', ');
			}
		})
       	return html;
	}

	var setupSegmentDataAndReports = function(segmentData) {
		 var segmentId = segmentData.id;
		 var name = segmentData.name;
		 var size = segmentData.totalCount;
		
		 var formatDateTime =  'YYYY-MM-DD HH:mm:ss';
		 $('#sm_indexScore').text(segmentData.indexScore);
		 $('#sm_name').text(name);
	     $('#sm_description').text(segmentData.description);
	     $('#sm_authorizedViewers').html(getHtmlForAuthorizedUserLogin(segmentData.authorizedViewers));
	     $('#sm_authorizedEditors').html(getHtmlForAuthorizedUserLogin(segmentData.authorizedEditors));
	     
	     $('b.segment_size').text(size.toLocaleString())
	     
	     var hasActivation = false;
	     
	     if( ! segmentData.disableDateRangeFilter ) {
	    	 $('#beginFilterDate').text( moment.utc(segmentData.beginFilterDate).local().format(formatDateTime)  );
		     $('#endFilterDate').text( moment.utc(segmentData.endFilterDate).local().format(formatDateTime) );
	     } else {
	    	 $('#segment_disable_date_filter_holder').hide();
	     }
	     
	     if(segmentData.for3rdSynchronization){
	    	 $('#sm_for3rdSynchronization').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_for3rdSynchronization').hide()
	     }
	     
	     if(segmentData.forDeepAnalytics){
	    	 //$('#sm_forDeepAnalytics').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forDeepAnalytics').hide()
	     }
	     
	     if(segmentData.forPredictiveAnalytics ){
	    	 //$('#sm_forPredictiveAnalytics').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forPredictiveAnalytics').hide()
	     }
	     
	     if(segmentData.forPersonalization){
	    	 segmentDataPersonalization(segmentId, name, size)
	    	 $('#segment_data_personalization').show();
	    	 $('#sm_forPersonalization').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forPersonalization').hide()
	     }
	     
	     if(segmentData.forEmailMarketing && segmentData.forPersonalization ){
	    	//$('#sm_forEmailMarketing').show();
	    	hasActivation = true;
	     } else {
	    	 $('#sm_forEmailMarketing').hide()
	     }
	     
	     if(segmentData.forRealtimeMarketing && segmentData.forPersonalization ){
	    	 //$('#sm_forRealtimeMarketing').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forRealtimeMarketing').hide()
	     }
	     
	     // in version 2.0
	     if(segmentData.forReTargeting){
	    	 //$('#sm_forReTargeting').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forReTargeting').hide();
	     }
	     
	  	 // in version 2.0
	     if(segmentData.forLookalikeTargeting){
	    	 //$('#sm_forLookalikeTargeting').show();
	    	 hasActivation = true;
	     } else {
	    	 $('#sm_forLookalikeTargeting').hide();
	     }
	     
	     if(!hasActivation){
	    	 $('#sm_no_activation_plan').show()
	     }
	}
	
	
	var doDataSynchronization = function(node){
		var connectorId = $('#dataConnectorHolder input[name="dataconnector"]:checked').val();
		if(typeof connectorId === "string"){
			var segmentId = $(node).data('segmentId');
			var segmentName = $(node).data('segmentName')

			var info = segmentName + " is being synchronized to [" + connectorId + "]";
			iziToast.info({ title: 'Information',message: info });
			$('#dialogDataSynchronization').modal('hide');
			
			LeoAdminApiUtil.callPostAdminApi('/cdp/data-connector/trigger',{"segmentId" : segmentId, "connectorId" : connectorId}, function(json) { 
				if(json.data === connectorId){
					var info =  'Data Synchronization is OK for the segment [' + segmentName + ']';
					iziToast.success({title: 'OK', message: info});
				}
				else {
					var msg = 'Data Synchronization is failed for the segment [' + segmentName + '], please set valid API keys for ' + connectorId;
					iziToast.error({ title: 'Error', message: msg});
				}
			})
		} else {
			iziToast.error({ title: 'Error', message: "Please select a connector to synchronize data"});
		}
	}
	
	var showDataSynchronizationDialog = function(segmentId, segmentName, segmentSize) {	
		$('#dialogDataSynchronization').modal({
    		backdrop: 'static',
    		keyboard: false
		});
		$('#synchronizationOkButton').data("segmentId",segmentId).data("segmentName",segmentName);
	}
	
	var emailTemplateToActivateSegment = false;
	var showEmailMarketingDialog = function(segmentId, segmentName, segmentSize) {
		
  		$('#dialogEmailMarketing').modal({
      		backdrop: 'static',
      		keyboard: false
  		});
		
		// EMAIL_CONTENT
		var urlStr = window.baseLeoAdminUrl + "/item/asset-templates-for-email";
    	LeoAdminApiUtil.getSecuredData(urlStr, {}, function (json) { 
    		// priority group selector
			var pgSelector = $('#emailTemplateSelector');
			pgSelector.find("option").remove();
			
			var firstId = false;
    		json.data.forEach(function(group,i){ 
    			var id = group.id;
    			var option = '<option value="'+id+'" >' + group.title + '</option>';
    			pgSelector.append(option);
    			if(emailTemplateToActivateSegment === false) {
    				emailTemplateToActivateSegment = id;
    			}
    		})
    		
    		// select the first
    		if(typeof emailTemplateToActivateSegment === "string"){
    			pgSelector.val(emailTemplateToActivateSegment).change();
    		}
    		
    		// set the first
    		pgSelector.chosen({
                width: "100%",
                no_results_text: "Oops, nothing found!"
            }).trigger("chosen:updated").change(function(){
            	console.log("chosen:updated" + $(this).val());
            	emailTemplateToActivateSegment = $(this).val();
            });
    	})
	}
	
	var segmentDataPersonalization = function(segmentId, segmentName, segmentSize) {
		// PRODUCT_ITEM_CATALOG
		var paramObj = { 'assetType': 2 };
		var urlStr = window.baseLeoAdminUrl + "/group/list-by-asset-type";
		LeoAdminApiUtil.getSecuredData(urlStr, paramObj , function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
            	
            	// priority group selector
    			var pgSelector = $('#priorityGroupSelector');
    			pgSelector.find("option").remove();
    			
	    		json.data.forEach(function(group,i){ 
	    			var id = group.id;
	    			var option = '<option value="'+id+'" >' + group.title + '</option>';
	    			pgSelector.append(option);
	    		})
	    		
	    		// set the first
	    		pgSelector.chosen({
	                width: "100%",
	                no_results_text: "Oops, nothing found!"
	            }).trigger("chosen:updated").change(function(){
	            	console.log("chosen:updated" + $(this).val())
	            });
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
        });
	}
	
	function doSetItemsToRecommenderSystem() {
		var segmentId = segmentDataModel.id;
		var groupId = $('#priorityGroupSelector').val();
		
		if(groupId && groupId !== ""){
			iziToast.info({
			    title: 'Information Box',
			    color : 'green',
			    message: 'Starting the process to set data for recommmender system'
			});
		    
		    var urlStr = baseLeoAdminUrl + '/group/set-items-to-recommender-system';
		    var params = { "groupId": groupId, "segmentId" : segmentId };
		    
		    LeoAdminApiUtil.callPostAdminApi(urlStr, params, function (json) {
		         if (json.httpCode === 0 && json.errorMessage === '') {
		        	 var c = json.data;
		        	 iziToast.info({
		       		    title: 'Information Box',
		       		    color : 'green',
		       		    message: 'Finished the process to set data for recommmender system, total graph edges: ' + c 
		       		});
		         }
		    });
		}
	}
</script>


<!-- Email Marketing dialog html -->
<div class="modal fade" id="dialogEmailMarketing" role="dialog">
	<div class="modal-dialog modal-lg">
		<!-- Modal content-->
		<div class="modal-content">   
			<div class="modal-header">
				<h4 class="modal-title text-center" > Activate Direct Email Marketing </h4>
			</div>         
			<div class="modal-body ">
				<div class="alert alert-warning" role="alert">
					<i class="fa fa-info-circle" aria-hidden="true"></i> Before sending email directly to profile, you should set data personalization for this segment !
				</div>
				
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Total Profile Count </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<b class="segment_size" >0</b>
		     		</div>
				</div>
			
				<div class="form-group highlight_box" >
		     		<div class="col-lg-12">
		     			<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> Email Data Connectors </label>
		     		</div>
		     		<div id="emailConnectorHolder" style="padding-left: 32px;" >
		     			 <div class="radio">
						  	<label for="ec_sendinblue" ><input id="ec_sendinblue" type="radio" value="sendinblue" name="dataconnector">SendInBlue email service</label>
						 </div>
						 <div class="radio">
						  	<label for="ec_mailchimp" ><input id="ec_mailchimp" type="radio" value="mailchimp" name="dataconnector">MailChimp email service</label>
						</div>
						<div class="radio">
						  	<label for="ec_local_smtp_mail_server" ><input id="ec_local_smtp_mail_server" type="radio" value="local_smtp_mail_server" name="dataconnector">SMTP mail server to send email directly</label>
						</div>
		     		</div>
				</div>
				
				<div class="form-group highlight_box" >
					<div class="col-lg-5">
	                	<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> Email Template </label>
	                </div>
		     		<div class="col-lg-7"  >
		                <select id="emailTemplateSelector" data-placeholder="Choose a email template" class="select" >
		                  	<!-- emailTemplateSelector -->  
		                </select>
	                </div>
	            </div>
	            
	            <div class="form-group highlight_box" style="height: 50px;">
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Scheduling Time </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<select class="form-control" id="email_time_interval">
						    <option value="0"  > Send email immediately</option>
						    <option value="-6" > After 6 hours from now</option>
						    <option value="-8" > After 8 hours from now</option>
						    <option value="-12"> After 12 hours from now</option>
						    <option value="24" > Every 24 hours at 7 AM</option>
						    <option value="48" > Every 48 hours at 7 AM</option>
						    <option value="72" > Every 72 hours at 7 AM</option>
						    <option value="-1" > Every Workday at 7 AM</option>
						    <option value="-2" > Every Saturday at 10 AM</option>
						</select>
		     		</div>
				</div>
				
			</div>  
			
			<div class="modal-footer" >
				<button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Close</button>
				<button type="button" class="btn btn-do-now" onclick="sendEmailToAllProfileInSegment()"><i class="fa fa-check" aria-hidden="true"></i> OK </button>
		    </div>  
		</div>
	</div>
</div>

<!-- Synchronization dialog html -->
<div class="modal fade" id="dialogDataSynchronization" role="dialog">
	<div class="modal-dialog">
		<!-- Modal content-->
		<div class="modal-content">   
			<div class="modal-header">
				<h4 class="modal-title text-center" > Data Connection for Synchronization </h4>
			</div>         
			<div class="modal-body row">
				<div class="form-group highlight_box" >
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Total Profile Count </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<b class="segment_size" >0</b>
		     		</div>
				</div>
			
				<div class="form-group highlight_box"  >
		     		<div class="col-lg-12 ">
		     			<label class="label_box" > <i class="fa fa-info-circle" aria-hidden="true"></i> Data Connectors </label>
		     		</div>
		     		<div id="dataConnectorHolder" style="padding-left: 32px;" >
		     			 <div class="radio">
						  	<label for="c_sendinblue" ><input id="c_sendinblue" type="radio" value="sendinblue" name="dataconnector"> SendInBlue Email Marketing Automation </label>
						 </div>
						 <div class="radio">
						  	<label for="c_mailchimp" ><input id="c_mailchimp" type="radio" value="mailchimp" name="dataconnector"> MailChimp Email Marketing Automation </label>
						</div>
		     		</div>
				</div>
				
				<div class="form-group highlight_box" style="height: 50px;">
		     		<div class="col-lg-5">
		     			<label class="label_box"  > <i class="fa fa-info-circle" aria-hidden="true"></i> Scheduling Time </label>
		     		</div>
		     		<div class="col-lg-7">
		     			<select class="form-control" id="data_synch_time_interval">
						    <option value="0" > Synch data immediately</option>
						    <!--  
						    <option value="1" > Every 1 hour from now </option>
						    <option value="2" > Every 2 hours from now </option>
						    <option value="3" > Every 3 hours from now </option>
						    <option value="6" > Every 6 hours from now </option>
						    <option value="12" > Every 12 hours from now </option>
						    <option value="24" > Every 24 hours from now </option>
						    <option value="48" > Every 48 hours from now </option>
						    <option value="72" > Every 72 hours from now </option>
						    <option value="168" > Every week from now </option>
						    -->
						</select>
		     		</div>
				</div>
			</div>  
			
			<div class="modal-footer" >
				<button type="button" class="btn btn-do-now" id="synchronizationOkButton" onclick="doDataSynchronization(this)">
					<i class="fa fa-check" aria-hidden="true"></i> OK 
				</button>
		        <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> Close</button>
		    </div>  
		</div>
	</div>
</div>
