<style>
	.jsgrid .jsgrid-custom-button {
	    border: none;
	    cursor: pointer;
	    background-color: transparent;
	}
	.jsgrid .event-set-rules {
		font-size:1.2em; color:blue;
	}
	.modal-body .eventName {
		font-size:1.5em; color:blue; font-weight: bold;
	}
	tr > td.jsgrid-cell:nth-of-type(1) {
		font-size:13px; color:blue;
	}
	
	.editable_event_metric {
		background-color: #FFF8DC;
    	border-radius: 8px;
    	padding: 4px;
	}
	div.data_funnel {
		width:98% !important; 
		margin: auto !important;  
		max-width: 550px !important; 
	}
</style>

<div class="row">
    <div class="col-lg-12">
        <h5 class="page-header" id="page_breadcrumb" > </h5>
    </div>
</div>

<div class="container-fluid">

    <div class="row" >
  		<div class="row col-lg-12 text-center">

			 <div class="col-md-6 ">
                 <h4 class="chart_header text-center" > Data Funnel for Customer Journey Segmentation </h4>
                 <div class="summary_metric data_funnel" >
	               <div class="vcenter">
	                  <div id="journey_funnel" ></div>
	               </div>
	           	</div>
            </div>

  			<div class="col-md-6" >
                 <h4 class="chart_header text-center" > Data Funnel for Customer Profile Segmentation </h4>
                 <div class="summary_metric data_funnel" >
	               <div class="vcenter">
	                  <div id="profile_funnel" ></div>
	               </div>
	           	</div>
            </div>

        </div>
        
        <div class="col-lg-12" style="margin-top: 8px;">
         	<h4 class="text-center"> <mark> All Event Metrics for Data Segmentation</mark> (The table is sorted by the Event Score) </h4>
            <div class="table-responsive">
                <div id="behavioral_metrics_table"></div>
            </div>
        </div>
    </div>

</div>

<script>
	// global var
	var behavioralMetricsData = [], journeyFunnelStages, customerFunnelStages;

	var initBehavioralEventList = function() {
		var profileFunnelOptions = {
				block: {
	   	   			highlight: true,
		   	   		fill: {
		                type: 'gradient'
		            }
	   	   	    },
		        chart: {
		        	curve: { enabled: true, height: 36 },
		            height: 360,
		            bottomWidth : 0.57,
		            bottomPinch: 1
		        },
		        tooltip: {
		            enabled: true
		        },
		        label: {
		            fontSize: '14px'
		        },
		        events: {
		            click: {
		                block: function (data) {
		                    console.log(data.label.raw);
		                }
		            }
		        }
		};
		
		var journeyFunnelOptions = {
				block: {
	   	   			highlight: true,
		   	   		fill: {
		                type: 'gradient'
		            }
	   	   	    },
		        chart: {
		        	curve: { enabled: true, height: 36 },
		            height: 360,
		            bottomWidth : 0.57,
		            bottomPinch: 1
		        },
		        tooltip: {
		            enabled: true
		        },
		        label: {
		            fontSize: '14px'
		        },
		        events: {
		            click: {
		                block: function (data) {
		                    console.log(data.label.raw);
		                }
		            }
		        }
		}
	
	    var eventDataTypes = [
	        { name: "First-party Data", id: 1 },
	        { name: "Second-party Data", id: 2 },
	        { name: "Third-party Data", id: 3 }
	    ];
	    
	    var metricTypes = [
	        { name: "IMPRESSION", id: 1 },
	        { name: "ACTION", id: 2 },
	        { name: "CONVERSION ", id: 3 },
	        { name: "FEEDBACK", id: 4 },
	        { name: "PROMOTION", id: 5 }
	    ];
	    
	    var scoringModels = [
	        { name: "LEAD", id: 1 },
	        { name: "PROSPECT", id: 2 },
	        { name: "ENGAGEMENT", id: 3 },
	        { name: "ACQUISITION", id: 5 },
	        { name: "LIFETIME_VALUE", id: 6 },
	        { name: "CX_EFFORT", id: 7 },
	        { name: "CX_SATISFACTION", id: 8 },
	        { name: "CX_FEEDBACK", id: 9 },
	        { name: "CX_PROMOTER", id: 10 },
	        { name: "CREDIT_SCORING", id: 11 },
	        { name: "CX_LOYALTY", id: 12 },
	        { name: "CX_DETRACTOR", id: 13}
	    ];
	    
	    var saveEventMetricMetaData = function(item){
			var callback = function(json){
	    		if(json.data != ""){
	    			location.reload(true);
	    		}
	    		else {
	    			console.error('saveEventMetricMetaData ', rs)
	    		}
	    	};
			var params = {'eventMetricJson' : JSON.stringify(item) };
	    	LeoAdminApiUtil.callPostAdminApi('/cdp/funnel/event-metric/save', params, function (json) {
	            if (json.httpCode === 0 && json.errorMessage === '') {
	    			callback(json);
	            } else {
	                LeoAdminApiUtil.logErrorPayload(json);
	            }
	       });
		}
	    
	    var deleteEventMetricMetaData = function(eventName) {
    	 	$('#delete_callback').val('');
	    	$('#confirmDeleteDialog').modal({ focus: true });
	    	if (typeof eventName === "string" ) {
	    	     var callback = "deleteEventMetricMetaData" + eventName;
	    	     window[callback] = function () {
	    	    	var params = {'eventName' : eventName};
	   		    	LeoAdminApiUtil.callPostAdminApi('/cdp/funnel/event-metric/delete', params, function (json) {
	   		            if (json.httpCode === 0 && json.errorMessage === '') {
	   		            	setTimeout(function(){
	   		            		location.reload(true);
	   		            	}, 700)
	   		            } else {
	   		                LeoAdminApiUtil.logErrorPayload(json);
	   		            }
	   		       });
	    	     }
	    	     $('#delete_callback').val(callback);
	    	     $('#deletedInfoTitle').html("Event Metric: " + eventName);
	    	     $('#deletedInfoMsg').html('Delete Data Confirmation');
	    	}
		}
	   
	    
	    LeoAdminApiUtil.getSecuredData('/cdp/funnel/metadata', {} , function(json){ 
			 //console.log(json.data);	
			 var canInsertData = json.canInsertData; 
	    	 var canEditData = json.canEditData;
    		 var canDeleteData = json.canDeleteData;
			
			 if( ! canEditData ){
				$('button.data-control').attr('disabled','disabled');
			 }
			
			 behavioralMetricsData = json.data['behavioral_metrics'];
			 var currentFlowName = behavioralMetricsData[0] ? behavioralMetricsData[0].flowName : "general_business_event";
			 
			 journeyFunnelStages = json.data['business_event_flow'];
			 customerFunnelStages = json.data['general_data_funnel']; 
			 
			 renderFunnelChart("#profile_funnel",customerFunnelStages, profileFunnelOptions, getColorCodeProfileFunnel)
			 renderFunnelChart("#journey_funnel",journeyFunnelStages, journeyFunnelOptions, getColorCodeJourneyFunnel)
			 
			 // TODO
			 var insertItemReady = false, insertedIndex = -1;
			 var gridControls =  { type: "control", width: 70, editButton: true, deleteButton: true, itemTemplate: function(value, item) {
                    var $result = jsGrid.fields.control.prototype.itemTemplate.apply(this, arguments);
                    
                    var isSystemMetric = item.systemMetric;
                    var eventName = item.eventName;
                    var setRuleIcon, setRulesLabel;
                    setRuleIcon = '<i class="fa fa-cogs event-set-rules" style="" aria-hidden="true"></i>';
                    setRulesLabel = 'Edit Event Name: ' + eventName;
                    
                    var $setRulesButton = $("<button>").data("eventName",eventName).attr({class: "jsgrid-custom-button", title : setRulesLabel}).html(setRuleIcon)
                    .click(function(e) {
                    	console.log("setRules button ", $(this).data('eventName'));
                    	
                    	underDevelopment(this);
                        e.stopPropagation();
                    });       
                    
                    var cssClass = "customGridEditbutton jsgrid-button jsgrid-edit-button";
                    var $customEditButton = $("<button>").data("eventName",eventName).attr({class: cssClass,title:"Edit Event Metric"})
                    .click(function(e) {
                    	//underDevelopment(this);
                        //e.stopPropagation();
                        
                        console.log("Edit button ", $(this).data('eventName'))
                    });

                    var cssClass = "customGridDeletebutton jsgrid-button jsgrid-delete-button";
                   	var $customDeleteButton = $("<button>").data("eventName",eventName).attr({class: cssClass,title:"Delete Event Metric"})
                   	.click(function(e) {
                   		var eventName = $(this).data('eventName');
                   		if( isSystemMetric ){
                   			iziToast.info({
    		    	    	    title: 'Information Box',
    		    	    	    message: 'The event <b>[' + eventName +  ']</b> is the <b>event metric of system</b>. You can not delete this metric !'
    		    	    	});
                   		} else {
                       		deleteEventMetricMetaData(eventName)
                   		}
                   		
                      	e.stopPropagation();
                    });

                   	var rs = $("<div>");
                   	if(! isSystemMetric ) {
                   		rs.addClass("editable_event_metric");
                   		rs.attr("title","Click to edit or delete")
                   	} else {
                   		rs.attr("title","Event metric of system")
                   	}
                   	rs.append($customEditButton).append($customDeleteButton);
                   	
                   	return rs;
                 }
             }
			 
			 $("#behavioral_metrics_table").jsGrid({
			    width: "100%",
			    height: "auto",
	
			    inserting: canInsertData,
			    editing: true,
			    sorting: false,
			    paging: false,
			    data: behavioralMetricsData,
			    
			    confirmDeleting : canDeleteData,
			    deleteConfirm: function(item) {
			    	if(item.systemMetric) {
			    		return "The event metric <b>[" + item.eventName + "]</b> is the <b>event metric of system</b>. You can not delete this metric.";
				    }
		            return "The event metric [" + item.eventName + "] will be removed. Are you sure ? ";
		        },
	
		        onItemInserting: function(args) {
		        	$('tr > td.jsgrid-cell:nth-of-type(1)').each(function(){
		        		var eventName = $(this).text().trim();
		        		if(eventName === args.item.eventName) {
		        			args.cancel = true;
				            iziToast.info({
			    	    	    title: 'Info',
			    	    	    message: 'The event [' + eventName +  '] is already existed in the metric list!'
			    	    	});
		        		}
		        	})
	   		    	// default for new inserting item
	   		    	args.item.systemMetric = false;
	   		    	args.item.dataType = 1;
	   		    	args.item.flowName = currentFlowName;
	   		    },
			   
			    onItemInserted: function(args) {
			    	var item = args.item;
			    	if(item.eventName.trim() === "" || item.eventLabel.trim() === "") {
			    		 args.cancel = true;
			    	}
			    	else {
			    		saveEventMetricMetaData(args.item)
			    	}
			    }, 
			    
			    onItemEditing: function(args) {
		            if(args.item.systemMetric) {
		            	iziToast.info({
		    	    	    title: 'Information Box',
		    	    	    message: 'The event <b>[' + args.item.eventName +  ']</b> is the <b>event metric of system</b>. You can not edit this metric !'
		    	    	});
		            	args.cancel = true;
		            }
			    },
			    
			    onItemUpdated: function(args) {
			    	saveEventMetricMetaData(args.item)
			    }, 
			    
			    onItemDeleting: function(args) {
			        if(args.item.systemMetric) {
			            args.cancel = true;
			        }
			    },
			    
			    onRefreshed: function (args) {
			    	$('input.jsgrid-insert-mode-button').click(function(){
			        	console.log($('tr.jsgrid-insert-row').find('input[type="number"]'))
			           	$('tr.jsgrid-insert-row').find('input[type="number"]').val(0);
			        })
			    },
	
			    fields: [
			        { name: "eventName", title : "Event Name", align: 'center' , type: "text", validate: "required", validate: "required" },
			        { name: "eventLabel", title : "Event Label", align: 'center' , type: "text", width: 116, validate: "required" },
			        { name: "metricType", type: "select", title : "Metric Type", items: metricTypes, align: 'center', width: 68, valueField: "id", textField: "name" },
			        { name: "scoreModel", title : "Score Model", type: "select", items: scoringModels, width: 80, valueField: "id", textField: "name" },
			        { name: "score", title : "Event Score", type: "number", align: 'center', width: 40, validate: "required" },
			        { name: "cumulativePoint", title : "Loyalty Point", type: "number", width: 38, align: 'center', validate: "required" },
			        { name: "eventStageId", title : "Default Journey Stage", type: "select", items: journeyFunnelStages, valueField: "id", textField: "name" },
			        { name: "funnelStageId", title : "Default Profile Stage", type: "select", items: customerFunnelStages, valueField: "id", textField: "name" }
			        ,gridControls
			    ]
			});  
		});
	}
	
</script>