<div class="container-fluid" id="user_form">

    <!-- MAIN BODY here -->
    <div class="row">
		<div class="col-lg-9">
			<h5 class="page-header" id="page_breadcrumb" > </h5>
		</div>
		<div class="col-lg-3 text-right" style="padding: 10px">
	     	<button type="button" class="btn btn-info" onclick="history.back()" title="Go back"  > 
	       		<i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Back
	       	</button>
	       	<button type="button" class="btn btn-danger data-control-delete" onclick="deleteUserLoginAccount()" title="Delete Login Account" > 
	     		<i class="fa fa-trash" aria-hidden="true"></i> Delete 
	     	</button>
	       	<button type="button" class="btn btn-success data-control-edit" onclick="saveUserProfile()" title="Save Login Account"  > 
	     		<i class="fa fa-check-square-o" aria-hidden="true"></i> Save 
	     	</button>
	     </div>
	</div>
	
	<h4> Login Account Editor </h4>
	<hr>
	<div id="error-on-save" class="alert alert-danger" style="display: none;"></div>

    <!-- MAIN BODY here -->
    <div class="row">
        <div class="col-lg-12">
        	
        	<!--  Tab Navigation Items -->
		    <ul class="nav nav-tabs" data-tab-content="login_account_tabs" >
				<li class="active" >
					<a href="javascript:" data-target-tab="panel_login_account_tab_general" title="General Information" > <i class="fa fa-info-circle" aria-hidden="true"></i> General Information</a>
		       	</li>
		       	<li >
					<a href="javascript:" data-target-tab="panel_login_account_role" title="Account Permission" > <i class="fa fa-lock" aria-hidden="true"></i> User's Role</a>
		       	</li>
		       	<li data-for-superadmin="true" style="display: none;">
					<a href="javascript:loadAuthorizedJourneys()" data-target-tab="panel_login_account_authorized_journeys" title="Authorized Data Journeys" > <i class="fa fa-map-o" aria-hidden="true"></i> Authorized Journeys</a>
		       	</li>
		       	<li data-for-superadmin="true" style="display: none;">
					<a href="javascript:loadViewableProfiles()" data-target-tab="panel_login_account_viewable_profiles" title="Viewable Profiles" > <i class="fa fa-users" aria-hidden="true"></i> Viewable Profiles</a>
		       	</li>
		       	<li data-for-superadmin="true" style="display: none;">
					<a href="javascript:loadEditableProfiles()" data-target-tab="panel_login_account_editable_profiles" title="Editable Profiles" > <i class="fa fa-users" aria-hidden="true"></i> Editable Profiles</a>
		       	</li>
		       	<li data-for-superadmin="true" style="display: none;">
					<a href="javascript:loadViewableSegments()" data-target-tab="panel_login_account_viewable_segments" title="Viewable Segments" > <i class="fa fa-object-group" aria-hidden="true"></i> Viewable Segments</a>
		       	</li>
		       	<li data-for-superadmin="true" style="display: none;">
					<a href="javascript:loadEditableSegments()" data-target-tab="panel_login_account_editable_segments" title="Editable Segments" > <i class="fa fa-object-group" aria-hidden="true"></i> Editable Segments</a>
		       	</li>
		  	</ul>
		  	
		  	<!-- Tab Contents  -->
	    	<div id="login_account_tabs" class="tab-content" style="min-height: 820px;"  >
	    		<!-- tab 1 General Login Information  -->
				<div class="tab-pane active" id="panel_login_account_tab_general" >
					<h4 class="highlight_text"> <i class="fa fa-info-circle" aria-hidden="true"></i> General Information </h4>
					
					<div class="form-group">
	                    <label> Display Name</label>
	                    <input type="text" class="form-control" placeholder="Enter Display Name" name="displayName"
	                        autocorrect="off" autocapitalize="off" autocomplete="off required ">
	                </div>
	                <div class="form-group">
	                    <label> User Login </label>
	                    <input data-validation="length alphanumeric" data-validation-length="min4" type="text" class="form-control"
	                        placeholder="Enter User Login" name="userLogin" autocomplete="nope" autocorrect="off"
	                        autocapitalize="none" spellcheck="false" required >
	                </div>
	                <div class="form-group">
	                    <label> Email </label>
	                    <input data-validation="email" type="email" class="form-control" placeholder="Enter Email" name="userEmail"
	                        autocorrect="off" autocapitalize="off" autocomplete="off" required  >
	                </div>
	                <div class="form-group">
	                    <label> Password </label>
	                    <input type="text" class="form-control" placeholder="Enter New Password To Update" name="userPass" autocorrect="off"
	                        autocapitalize="off" autocomplete="nope"  >
	                </div>
	                <hr>
	                
	                <div class="action-div">
	                    <label>Status</label>
	                    <div class="radio">
	                        <label><input type="radio" name="status" value="0"> Pending for email confirmation </label>
	                    </div>
	                    <div class="radio">
	                        <label ><input type="radio" name="status" value="1"> Active account </label>
	                    </div>
	                    <div class="radio">
	                        <label><input type="radio" name="status" value="2"> Disabled account </label>
	                    </div>
	                </div>
	                <hr>
	                
	                <div class="form-group">
	                    <label> Department / Business Unit </label>
	                    <select name="businessUnit" data-placeholder="Choose Business Unit" class="select">
	                        <option value=""> No data</option>
	                        <option value="bod"> Board of Directors (BOD) </option>
	                        <option value="investor"> Investor </option>
	                        <option value="data_engineering_team"> Data Engineering </option>
	                        <option value="data_science_team"> Data Science </option>
	                        <option value="ai_team"> A.I team </option>
	                        <option value="marketing"> Marketing </option>
	                        <option value="market_research"> Market Research </option>
	                        <option value="finance"> Finance </option>
	                        <option value="biz_operation"> Business Operation </option>
	                        <option value="pr_operation"> PR Operation </option>
	                        <option value="product_operation"> Product Operation </option>
	                        <option value="engineering"> Product Engineering </option>
	                        <option value="product_rnd"> Product R&D  </option>
	                        <option value="logistics"> Logistics </option>
	                        <option value="customer_support"> Customer Support </option>
	                        <option value="trading"> Trading </option>
	                        <option value="purchasing"> Purchasing </option>
	                        <option value="sales_team"> Sales team </option>
	                        <option value="tech"> IT / Technology Support </option>
	                        <option value="media_agency"> Media Agency </option>
	                        <option value="sales_agent"> Sales Agent / Sales Representative </option>
	                    </select>
	                </div>
	                <div class="form-group">
	                    <label> Job Title / Job Position </label>
	                    <input type="text" class="form-control" placeholder="Enter Position" name="customData_position"
	                        autocorrect="off" autocapitalize="off" autocomplete="off">
	                </div>
	                
				</div>
				
				<!-- tab 2 Account Permissions  -->
				<div class="tab-pane" id="panel_login_account_role" >
					<div class="action-div">
	                    <h4 class="highlight_text"> <i class="fa fa-lock" aria-hidden="true"></i> User's Role for Permission </h4>
	                    <div class="radio" >
	                        <label><input type="radio" name="role" value="0"  > 
	                        	<b>REPORT VIEWER</b>: the login account can access Unified Analytics Hub to view summary reports </label>
	                    </div>
	                    <hr>
	                    <div class="radio"  >
	                        <label><input type="radio" name="role" value="1" > 
	                        	<b>CUSTOMER DATA VIEWER</b>: the login account has permissions to view authorized customer data (profiles and segments)</label>
	                    </div>
	                    <div class="radio"  >
	                        <label><input type="radio" name="role" value="2" > 
	                        	<b>STANDARD USER</b>: the login account can access Unified Analytics Hub and view authorized customer data  </label>
	                    </div>
	                    <hr>
	                    <div class="radio">
	                        <label><input type="radio" name="role" value="3" > 
	                        	<b>CUSTOMER DATA EDITOR</b>: the login account has permissions to manage authorized customer data (profiles and segments)</label>
	                    </div>
	                    <div class="radio">
	                        <label><input type="radio" name="role" value="4" > 
	                        	<b>DATA OPERATOR</b>: the login account has access Unified Analytics Hub, manage Journey Data Hub and update authorized customer profiles </label>
	                    </div>
	                    <hr>
	                    <div class="radio">
	                        <label><input type="radio" name="role" value="5" > 
	                        	<b>DATA ADMIN</b>: the login account has full permissions to manage customer data, can manage Data Asset and Data Connector </label>
	                    </div>
	                    <div class="radio">
	                        <label><input type="radio" name="role" value="6" > 
	                        	<b>SUPER ADMIN</b>: the login account has full of permissions to manage system and manage all user login accounts </label>
	                    </div>
	                </div>
				</div>
				
				<!-- tab 3 authorized journeys  -->
				<div class="tab-pane" id="panel_login_account_authorized_journeys" >
					<h4 class="highlight_text"> <i class="fa fa-map-o" aria-hidden="true"></i> Authorized Journeys for User Login: "<span class="authorized_user_login"></span>" </h4>
					<div id="authorized_journey_list_loader" class="loader"></div>
					<div id="authorized_journey_list" style="display: none;" >	
					    <!-- authorized journey list -->
						<div class="row gridholder">
						    <div class="col-lg-12">
						        <div class="table-responsive">
						            <table id="authorized_journey_list_table" class="display" style="width:100%;">
						                <thead>
						                    <tr>
						                        <th class="text-center">Journey Name</th>
						                        <th class="text-center">Can View Data</th>
						                        <th class="text-center">Can Edit Data</th>
						                        <th class="text-center">Created Time</th>
						                        <th class="text-center">Updated Time</th>
						                        <th class="text-center">Default Event Metric</th>
						                        <th class="text-center">Actions</th>
						                    </tr>
						                </thead>
						            </table>
						        </div>
						    </div>
						</div>
					</div> 
				</div>
				
				
				<!-- tab 4 Viewable Profiles  -->
				<div class="tab-pane" id="panel_login_account_viewable_profiles" >
					<h4 class="highlight_text"> <i class="fa fa-users" aria-hidden="true"></i> Viewable Profiles for User Login: "<span class="authorized_user_login"></span>" </h4>
					<div id="viewable_profile_list_loader" class="loader"></div>
					<div id="viewable_profile_list" style="display: none;" >	
					    <!-- viewable profile list -->
						<div class="row gridholder">
						    <div class="col-lg-12">
						        <div class="table-responsive">
						            <table id="viewable_profile_list_table" class="display" style="width:100%;">
						                <thead>
						                    <tr>
						                        <th class="text-center" title="A profile that has mobile phone or email">Is_Contact</th>
						                        <th> Full Name </th>
						                        <th class="text-center">Email</th>
						                        <th class="text-center">Phone</th>
						                        <th class="text-center">Last-seen Touchpoint</th>
						                        <th class="text-center">Data Quality</th>
						                        <th class="text-center">Lead Score</th>
						                        <th class="text-center">CLV Score</th>	                        
						                        <th class="text-center">Updated</th>
						                        <th class="text-center">Status</th>
						                        <th class="text-center">Actions</th>
						                    </tr>
						                </thead>
						            </table>
						        </div>
						    </div>
						</div>
					</div> 
				</div>
				
				<!-- tab 5 Editable Profiles -->
				<div class="tab-pane" id="panel_login_account_editable_profiles" >
					<h4 class="highlight_text"> <i class="fa fa-users" aria-hidden="true"></i> Editable Profiles for User Login: "<span class="authorized_user_login"></span>" </h4>
					<div id="editable_profile_list_loader" class="loader"></div>
					<div id="editable_profile_list" style="display: none;" >	
					    <!-- editable profile list -->
						<div class="row gridholder">
						    <div class="col-lg-12">
						        <div class="table-responsive">
						            <table id="editable_profile_list_table" class="display" style="width:100%;">
						                <thead>
						                    <tr>
						                        <th class="text-center" title="A profile that has mobile phone or email">Is_Contact</th>
						                        <th> Full Name </th>
						                        <th class="text-center">Email</th>
						                        <th class="text-center">Phone</th>
						                        <th class="text-center">Last-seen Touchpoint</th>
						                        <th class="text-center">Data Quality</th>
						                        <th class="text-center">Lead Score</th>
						                        <th class="text-center">CLV Score</th>	                        
						                        <th class="text-center">Updated</th>
						                        <th class="text-center">Status</th>
						                        <th class="text-center">Actions</th>
						                    </tr>
						                </thead>
						            </table>
						        </div>
						    </div>
						</div>
					</div> 
				</div>
				
				<!-- tab 6 Viewable Segment -->
				<div class="tab-pane" id="panel_login_account_viewable_segments" >
					<h4 class="highlight_text"> <i class="fa fa-object-group" aria-hidden="true"></i> Viewable Segments for User Login: "<span class="authorized_user_login"></span>" </h4>
					<div id="viewable_segment_list_loader" class="loader"></div>
					<div id="viewable_segment_list" style="display: none;" >	
					    <!-- viewable segment list -->
						<div class="row gridholder">
						    <div class="col-lg-12">
						        <div class="table-responsive">
						            <table id="viewable_segment_list_table" class="display" style="width:100%;">
						                <thead>
						                    <tr>
						                        <th>Segment Name</th>
							                    <th>Description</th>
							                    <th>Data Owner</th>
							                    <th>Created at</th>
							                    <th>Updated at</th>
							                    <th>Total Profile</th>
							                    <th>Actions</th>
						                    </tr>
						                </thead>
						            </table>
						        </div>
						    </div>
						</div>
					</div> 
				</div>
				
				<!-- tab 7 Editable Segments -->
				<div class="tab-pane" id="panel_login_account_editable_segments" >
					<h4 class="highlight_text"> <i class="fa fa-object-group" aria-hidden="true"></i> Editable Segments for User Login: "<span class="authorized_user_login"></span>" </h4>
					<div id="editable_segment_list_loader" class="loader"></div>
					<div id="editable_segment_list" style="display: none;" >	
					    <!-- editable profile list -->
						<div class="row gridholder">
						    <div class="col-lg-12">
						        <div class="table-responsive">
						            <table id="editable_segment_list_table" class="display" style="width:100%;">
						                <thead>
						                    <tr>
						                        <th>Segment Name</th>
							                    <th>Description</th>
							                    <th>Data Owner</th>
							                    <th>Created at</th>
							                    <th>Updated at</th>
							                    <th>Total Profile</th>
							                    <th>Actions</th>
						                    </tr>
						                </thead>
						            </table>
						        </div>
						    </div>
						</div>
					</div> 
				</div>
				
	    	</div>

        </div>
    </div>
</div>

<hr>

<script>
    var userLoginModel = false;

    var initUserLoginEditor = function(key) {
    	 setupTabPanels(key !== 'newuser');
    	 
         var urlStr = baseLeoAdminUrl + '/user/get';
         var params = { 'key': key || 'newuser' };
         
         LeoAdminApiUtil.callPostAdminApi(urlStr, params, function (json) {
             if (json.httpCode === 0 && json.errorMessage === '') {
                 if (json.data) {
                     userLoginModel = json.data;
                     var date = LeoAdminApiUtil.formater.toDateString(userLoginModel.creationTime);

                     var node = $('#user_form');
                     if (typeof userLoginModel.key === 'string') {
                         node.find('input[name="userLogin"]').val(userLoginModel.userLogin).attr('disabled', '');
                         node.find('input[name="status"][value=' + userLoginModel.status + ']').attr('checked', '');
                         node.find('input[name="role"][value=' + userLoginModel.role + ']').attr('checked', '');
                     } else {
                         node.find('input[name="userLogin"]').val(userLoginModel.userLogin);
                         node.find('input[name="status"][value=1]').attr('checked', '');
                         node.find('input[name="role"][value=1]').attr('checked', '');
                     }
                     node.find('input[name="displayName"]').val(userLoginModel.displayName);
                     node.find('input[name="userEmail"]').val(userLoginModel.userEmail);

                     //customData
                     var position = userLoginModel.customData.position ? userLoginModel.customData.position : '';
                     node.find('input[name="customData_position"]').val(position);

                     var businessUnit = userLoginModel.businessUnit ? userLoginModel.businessUnit : '';
                     node.find('select[name="businessUnit"] option[value="' + businessUnit + '"]').attr('selected', 'selected');
                     node.find('select[name="businessUnit"]').chosen({
                         width: "100%",
                         no_results_text: "Oops, nothing found!"
                     }).trigger("chosen:updated").change(function () {
                    	 //userLoginModel.group = $(this).val();
                     });

                     //can not delete superadmin
                     if(userLoginModel.userLogin === 'superadmin'){
                         $('#btn_delete').hide();                        
                     }
                     
                     // set authorized_user_login
                 	 $('span.authorized_user_login').text(userLoginModel.userLogin);
                 } 
             } else {
            	 notifyErrorMessage(json.errorMessage)
             }
         });
         
         
    }

    var saveUserProfile = function() {
        var node = $('#user_form');
        userLoginModel.displayName = node.find('input[name="displayName"]').val();
        userLoginModel.userLogin = node.find('input[name="userLogin"]').val();
        userLoginModel.userEmail = node.find('input[name="userEmail"]').val();
        userLoginModel.userPass = node.find('input[name="userPass"]').val();
        userLoginModel.status = parseInt(node.find('input[name="status"]:checked').val());
        userLoginModel.role = parseInt(node.find('input[name="role"]:checked').val());
        userLoginModel.businessUnit = node.find('select[name="businessUnit"]').val();
        userLoginModel.customData.position = node.find('input[name="customData_position"]').val();
        
        var urlStr = baseLeoAdminUrl + '/user/create';
        if (typeof userLoginModel.key === 'string') {
            urlStr = baseLeoAdminUrl + '/user/update';
        }

        var onSaveOk = function (data) {
        	 iziToast.info({
 	    	    title: 'Login Account Information',
 	    	    onClosed: function(){
 	    	    	location.hash = "calljs-leoCdpRouter('User_Login_Management')";
 	    	    },
 	    	    message: "Updated information successfully!",
 	    	    timeout: 3000
 	    	});
        }

        LeoAdminApiUtil.callPostAdminApi(urlStr, userLoginModel, function (json) {
            if (json.httpCode === 0 && json.errorMessage === '') {
                if (json.data === '') {
                    $('#error-on-save').html('Data is not valid !').show().delay(6000).fadeOut('slow');
                } else {
                    onSaveOk(json.data);
                }
            } else {
                $('#error-on-save').html(json.errorMessage).show().delay(6000).fadeOut('slow');
                LeoAdminApiUtil.logErrorPayload(json);
            }
        });
    }

    var deleteUserLoginAccount = function() {
    	if(userLoginModel){
    		var result = confirm("Do you want to delete " + userLoginModel.displayName + " ?");
            if (result) {
                var onSaveOk = function (data) {
                    iziToast.info({
        	    	    title: 'Delete Login Account',
        	    	    onClosed: function(){
        	    	    	location.hash = "calljs-leoCdpRouter('User_Login_Management')";
        	    	    },
        	    	    message: "The account login is deleted successfully!",
        	    	    timeout: 3000
        	    	});
                }
                var urlStr = baseLeoAdminUrl + '/user/delete';
                LeoAdminApiUtil.callPostAdminApi(urlStr, userLoginModel, function (json) {
                    if (json.httpCode === 0 && json.errorMessage === '') {
                        if (json.data === '') {
                            $('#error-on-save').html('Data is not valid !').show().delay(6000).fadeOut('slow');
                        } else {
                            onSaveOk(json.data);
                        }
                    } else {
                        $('#error-on-save').html(json.errorMessage).show().delay(6000).fadeOut('slow');
                        LeoAdminApiUtil.logErrorPayload(json);
                    }
                });
            }
    	}
    }
    
    var viewableProfilesTable = false;
    var loadViewableProfiles = function() {
    	var userLogin = $('#user_form').find('input[name="userLogin"]').val();
    	
    	var tableDomSel = "#viewable_profile_list_table";
    	var loaderDomSel = "#viewable_profile_list_loader";
    	var containerDomSel = "#viewable_profile_list";
    	
    	if(userLoginModel.role >= 5){
    		$(loaderDomSel).hide();
    		$(containerDomSel).html("<h3>Admin account can view all profiles</h3>").show()
    	}
    	else {
    		if(typeof viewableProfilesTable === "object"){
        		viewableProfilesTable.ajax.reload();
        	}
        	else {
            	var profileFilterParams = function(d) {
            		d.authorizedViewer = userLogin;
            		return d;
            	}
            	viewableProfilesTable = loadProfileListByFilter(containerDomSel, loaderDomSel, tableDomSel, profileFilterParams);
        	}
    	}
    	
    	
    }
    
    var editableProfilesTable = false;
    var loadEditableProfiles = function() {
    	var userLogin = $('#user_form').find('input[name="userLogin"]').val();
    	var tableDomSel = "#editable_profile_list_table";
    	var loaderDomSel = "#editable_profile_list_loader";
    	var containerDomSel = "#editable_profile_list";
    	
    	if(userLoginModel.role >= 5){
    		$(loaderDomSel).hide();
    		$(containerDomSel).html("<h3>Admin account can edit all profiles</h3>").show()
    	}
    	else {
    		if(typeof editableProfilesTable === "object"){
        		editableProfilesTable.ajax.reload();
        	}
        	else {
            	var profileFilterParams = function(d) {
            		d.authorizedEditor = userLogin;
            		return d;
            	}
            	editableProfilesTable = loadProfileListByFilter(containerDomSel, loaderDomSel, tableDomSel, profileFilterParams);
        	}
    	}
    }
    
    var viewableSegmentsTable = false;
    var loadViewableSegments = function() {
    	var userLogin = $('#user_form').find('input[name="userLogin"]').val();
    	var tableDomSel = "#viewable_segment_list_table";
    	var loaderDomSel = "#viewable_segment_list_loader";
    	var containerDomSel = "#viewable_segment_list";
    	
    	if(userLoginModel.role >= 5){
    		$(loaderDomSel).hide();
    		$(containerDomSel).html("<h3>Admin account can view all segments</h3>").show()
    	}
    	else {
    		if(typeof viewableSegmentsTable === "object"){
        		viewableSegmentsTable.ajax.reload();
        	}
        	else {
            	var filterParams = function(d) {
            		d.authorizedViewer = userLogin;
            		return d;
            	}
            	viewableSegmentsTable = loadSegmentListByFilter(containerDomSel, loaderDomSel, tableDomSel, filterParams);
        	}
    	}
    }
    
    var editableSegmentsTable = false;
    var loadEditableSegments = function() {
    	var userLogin = $('#user_form').find('input[name="userLogin"]').val();
    	var tableDomSel = "#editable_segment_list_table";
    	var loaderDomSel = "#editable_segment_list_loader";
    	var containerDomSel = "#editable_segment_list";
    	
    	if(userLoginModel.role >= 5){
    		$(loaderDomSel).hide();
    		$(containerDomSel).html("<h3>Admin account can edit all segments</h3>").show()
    	}
    	else {
    		if(typeof editableSegmentsTable === "object"){
        		editableSegmentsTable.ajax.reload();
        	}
        	else {
            	var filterParams = function(d) {
            		d.authorizedEditor = userLogin;
            		return d;
            	}
            	editableSegmentsTable = loadSegmentListByFilter(containerDomSel, loaderDomSel, tableDomSel, filterParams);
        	}
    	}
    }
    
    var authorizedJourneyTable = false;
    var loadAuthorizedJourneys = function(){
    	var userLogin = $('#user_form').find('input[name="userLogin"]').val();
    	var tableDomSel = "#authorized_journey_list_table";
    	var loaderDomSel = "#authorized_journey_list_loader";
    	var containerDomSel = "#authorized_journey_list";
    	
    	if(userLoginModel.role >= 5){
    		$(loaderDomSel).hide();
    		$(containerDomSel).html("<h3>Admin account can view and edit all data journey maps</h3>").show()
    	}
    	else {
    		if(typeof authorizedJourneyTable === "object"){
    			authorizedJourneyTable.ajax.reload();
        	}
        	else {
            	var filterParams = function(d) {
            		d.authorizedViewer = userLogin;
            		d.authorizedEditor = userLogin;
            		return d;
            	}
            	authorizedJourneyTable = loadDataJourneyMapsByFilter(containerDomSel, loaderDomSel, tableDomSel, filterParams);
        	}
    	}
    }
    
</script>