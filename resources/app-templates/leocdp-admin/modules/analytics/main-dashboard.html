<style>
    #customer_source {
    	width: 100%; float:left;
    }
    #chart text, #customer_source text {
    	font-size:14px;
    }   
    #primary_dashboard svg {
    	margin:auto; display:block;
    }
	.collector-item {
		padding: 4px!important; 
	}
	#data_journey_funnel_wrapper {
		width: 96%; margin: auto; padding-bottom:40px; padding-top:15px;
	}
	#profile_funnel_wrapper {
		padding-bottom:20px; padding-top:10px;
	}
	.stats_item {
		background-color: #FFF8DC;
	    color: #0000CD;
	    border-radius: 6px;
	    padding: 3px;
	    font-weight: bold;
	    overflow: hidden;
	}
</style>


<div id="primary_dashboard_loader" class="loader"></div>
<div id="primary_dashboard" class="container-fluid"  style="display: none;" >

    <div class="row">
        
        <div class="col-md-9">
				
         	<div class="report_page_header">
				<h4> <i class="fa fa-area-chart" aria-hidden="true"></i> 
					Customer Data Report from <mark id="beginReportDate"></mark> to <mark id="endReportDate" ></mark> 
				</h4>
			</div>
			
        	<div class="row float-right">
        		<div class='col-md-4 col-xs-12' style="border-right:1px solid #000;height: 60px;" >
        			<label for="journeyMapList">Data Journey Map</label>
        			<div>
        				<select id="journeyMapList" data-placeholder="Choose an Journey Map" class="select" > </select>
        			</div>
        		</div>
		        <div class='col-md-3 col-xs-12'  >
		            <div class="form-group">
		                <div class='input-group date' id='beginFilterDate'>
		                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
		                        <span class="glyphicon glyphicon-calendar"></span>
		                    </span>
		                </div>
		            </div>
		        </div>
		        <div class='col-md-3 col-xs-12'>
		            <div class="form-group">
		                <div class='input-group date' id='endFilterDate'>
		                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
		                        <span class="glyphicon glyphicon-calendar"></span>
		                    </span>
		                </div>
		            </div>
		        </div>
		        <div class='col-md-2 col-xs-12 text-center'>
		        	<button type="button" class="btn btn-do-now" style="width: 86%" onclick="showDashboardReport(true)" > 
		        		<i class="fa fa-check" aria-hidden="true"></i> OK </button>
		        </div>
		    </div>
	       
            <div class="chart_box"  >
            	<ul class="nav nav-tabs" data-tab-content="main_dashboard_report_tabs" >
		         	<li class="active" onclick="showDashboardReport(false)" >
		          		<a href="javascript:" data-target-tab="panel_journey_map_report" title="Journey Map Report"> <i class="fa fa-map-o" aria-hidden="true"></i> Data Journey Report </a>
		         	</li>
		         	<li>
		         		<a href="javascript:" data-target-tab="panel_data_funnel_report" title="Data Funnel Report" > <i class="fa fa-filter" aria-hidden="true"></i> Profile Funnel Report </a>
		         	</li>
	   			</ul>
	   			
	   			<div class="tab-content" id="main_dashboard_report_tabs" style="min-height: 450px"  >

					<!-- tab 1 Journey Map Report  -->
					<div class="highlight_box tab-pane active" id="panel_journey_map_report"  >
						<div id="data_journey_funnel_wrapper" class="vcenter" >
	                  		<div id="data_journey_funnel" class="funnel" ></div>
	               		</div>
					</div>
					
					<!-- tab 2 Data Funnel Report   -->
					<div class="highlight_box tab-pane" id="panel_data_funnel_report" >
						<div id="profile_funnel_wrapper" class="vcenter" >
	                  		<div id="profile_funnel"></div>
	               		</div>
					</div>
				</div>
	            
            </div>
            
        </div>
        
        <!-- holder for Total Customer Statistics and Total Event Statistics -->
        <div class="col-md-3"> 
        	<div class="chart_box">
	        		            
	            <div class="panel panel-summary" >
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Summary Report </h4> </div>
				  	<div class="panel-body" id="profile_total_stats">
				  		<!--  Summary: profile, segment, revenue -->
				  	</div>
				</div>
	            
	            <div class="panel panel-marketing">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Marketing Report in Total</h4> </div>
				  	<div class="panel-body" id="marketing_metrics_holder" >
				  	</div>
				</div>
				
				<div class="panel panel-business">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Sales Report in Total</h4> </div>
				  	<div class="panel-body" id="sales_metrics_holder" >
				  	</div>
				</div>
				
				<div class="panel panel-cx">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> CX Report in Total</h4> </div>
				  	<div class="panel-body" id="cx_metrics_holder" >
				  	</div>
				</div>
	            
	       	</div>
        </div>
        
    </div>
   
    <div class="row chart_box" style="display: none;" >
     	<div class="col-md-3" >
     		<div id="customer_source" >
                <h4 class="chart_header" > Media Sources </h4>
            </div>
     	</div>
    	<div class="col-md-12">
	        <h4 class="chart_header" style="width: 100%;" > Total Visitor Statistics of Media Channels </h4>
	        <div id="chart" style="text-align:center;">
	            <svg></svg>
	        </div>
        </div>
    </div>

</div>
<br><br>

<script>
	//select date
	var journeyMapIdToReport = "id_default_journey"; 
    var initPrimaryDashboard = function () {
    	setupTabPanels();
    	updateProfileChartWrapper();		
    	//initDateFilterComponent(false);
    	initDateFilterComponent(false, null, null, 45);
    	
    	showDashboardReport(true);
    	
    	loadJourneyMapList(false, function(id){
    		journeyMapIdToReport = id;
    		showDashboardReport(true)
        });
    	
    	//loadEventStatistics()
        
        //loadChannelPerformance();
      	//loadCustomerVenn();
    }
	
	var mainDashboardFunnelHeight = 420;
	var dashboardFontSize = 14;
	
	var updateProfileChartWrapper = function() {
		var container = $('#profile_funnel_wrapper');
		var ws = $(window).width();
		if(ws > 1500 && ws < 1650 ){
			container.css("width","90%");
		}
		else if(ws > 1650 && ws < 1750 ){
			container.css("width","96%");
		}
		else if(ws > 1750 ){
			container.css("width","98%");
		}
		
		var wh = $(window).height();
		var ratio = ws / wh;
		
		if(ratio >= 1.7 && ratio < 2.3 && ws > 1400 && wh > 700){
			mainDashboardFunnelHeight = wh - (Math.floor(window.innerHeight/3) + 186);
			dashboardFontSize = 15;
		}
		else if(ratio >= 2.3 && ws > 1400 && wh > 700){
			mainDashboardFunnelHeight = wh - (Math.floor(window.innerHeight/3) + 116);
			dashboardFontSize = 16;
		}
	}
	
	var dashboardDataModel = false;
	
    var showDashboardReport = function(refresh) {
    	
    	var queryFilter = getDateFilterValues();
    	
    	var beginReportDate = queryFilter.beginFilterDate;
    	$('#beginReportDate').text(new moment(beginReportDate).format(defaultDateFormat))
    	
    	var endReportDate = queryFilter.endFilterDate;
    	$('#endReportDate').text(new moment(endReportDate).format(defaultDateFormat))
        
    	var dataFunnelOptions = {
   	   		block: {
   	   			highlight: true,
	   	   		fill: {
	                type: 'gradient'
	            }
   	   	    },
   	        chart: {
   	         	curve: {
   	                 enabled: true,
   	                 height: 32
   	             },
   	             height: mainDashboardFunnelHeight,
   	             bottomWidth : 0.64,
	             bottomPinch: 1,
	             width: mainDashboardFunnelHeight * 4/3
   	         },
   	         tooltip: {
   	             enabled: true
   	         },
   	         label: {
   	        	fontSize: dashboardFontSize+'px'
   	         },
   	         events: {
   	             click: {
   	                 block: function (data) {
   	                     console.log(data.label.raw);
   	                 }
   	             }
   	         }
   	    };

  	    var visualizeFunnel = function (domSelector, list) {
  	        var data = [];
	  	    for(var i=0; i < list.length; i++){
	  	    	var e = list[i];
	  	    	var value = new Number(e.collectorCount).toLocaleString();
	  	    	var colorCode = getColorCodeProfileFunnel(i+1);
	  			data.push([e.collectorKey, value, colorCode ]);
	  		}
  	        var chart = new D3Funnel(domSelector);
  	        chart.draw(data, dataFunnelOptions);
  	    }
    	
    	var showTotalStatistics = function(profileTotalStats) {
    		
    		// empty 4 data boxes 
    		$('#profile_total_stats').empty();
    		$('#marketing_metrics_holder').empty();
    		$('#sales_metrics_holder').empty();
    		$('#cx_metrics_holder').empty();
    		
    		for(var i=0; i < profileTotalStats.length; i++){
    			var obj = profileTotalStats[i];
    			var label = obj.collectorKey;
				var value = obj.collectorCount;
				var flowType = obj.flowType;
				
    			if(flowType === 0){
    				$('#profile_total_stats').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
    			else if(flowType === 1) {
    				$('#marketing_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
				else if(flowType === 2) {
					$('#sales_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
				else if(flowType === 3) {
					$('#cx_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
    		}
    	}
    	
    	var updateChartDashboard = function(){
   			var profileTotalStats = dashboardDataModel.profileTotalStats;
   	        showTotalStatistics(profileTotalStats);
   	        
   	        var profileFunnelData = dashboardDataModel.profileFunnelData;
   	        visualizeFunnel('#profile_funnel', profileFunnelData);
   	        
   	        var journeyStatsData = dashboardDataModel.journeyStatsData;
   	        
   	        $('#data_journey_funnel').empty();
   	        reportJourneyOfAllProfiles('#data_journey_funnel', journeyStatsData);
    	}
        
    	if(dashboardDataModel === false || refresh === true){
    		$("#primary_dashboard_loader").show();
        	$("#primary_dashboard").hide();
        	
        	var urlStr = baseLeoAdminUrl + '/cdp/analytics360/dashboard-primary';
        	queryFilter['journeyMapId'] = journeyMapIdToReport;
            LeoAdminApiUtil.getSecuredData(urlStr, queryFilter , function (json) {
            	$("#primary_dashboard_loader").hide();
            	$("#primary_dashboard").show();
            	
                if (json.httpCode === 0 && json.errorMessage === '') {
                	dashboardDataModel = json.data;
                	updateChartDashboard();
                } else {
                    LeoAdminApiUtil.logErrorPayload(json);
                }
            });
    	}
    	else {
    		updateChartDashboard();
    	}
    }
    
    var reportJourneyOfAllProfiles = function(containerId, journeyStatsData) {
    	var dataModel = {
            labels: journeyLabel5A,
            subLabels: ['VISITOR PROFILE', 'CONTACT PROFILE'],
            colors: [            
                ['#D6EAF8', '#85C1E9', '#3498DB'],
                ['#B7F0B7', '#8CF08C', '#5CF45C']
            ],
            values: journeyStatsData
        };
    	var containerWidth = $(containerId).parent().width();
    	var graph = new FunnelGraph({
            container: containerId,
            gradientDirection: 'horizontal',
            data: dataModel,
            displayPercent: true,
            direction: 'horizontal',
            width: containerWidth,
            height: 350,
            subLabelValue: 'percent'
        });
    	graph.draw();
    }
</script>