<style>
    #customer_source {
    	width: 100%; float:left;
    }
    #chart text, #customer_source text {
    	font-size:14px;
    }   
    #primary_dashboard svg {
    	margin:auto; display:block;
    }
	#profile_journey_funnel_wrapper {
		width: 96%; margin: auto; padding-bottom:40px; padding-top:15px;
	}
	#profile_funnel_wrapper {
		padding-bottom:20px; padding-top:10px;
	}
	#flow_network_report_wrapper {
		display:block; height:680px; width:100%; background-color:#e8e8e8; border-radius:10px;
	}
</style>

<div id="primary_dashboard_loader" class="loader"></div>
<div id="primary_dashboard" class="container-fluid"  style="display: none;" >

    <div class="row">
        
        <div class="col-md-9">
				
         	<div class="report_page_header">
				<h4> <i class="fa fa-area-chart" aria-hidden="true"></i> 
					Customer Data Report from <mark id="beginReportDate"></mark> to <mark id="endReportDate" ></mark> 
				</h4>
			</div>
			
        	<div class="row float-right">
        		<div class='col-md-4 col-xs-12' style="border-right:1px solid #000;height: 60px;font-weight: bold;" >
        			<label for="journeyMapList">Data Journey Map</label>
        			<div>
        				<select id="journeyMapList" data-placeholder="Choose an Journey Map" class="select" > </select>
        			</div>
        		</div>
		        <div class='col-md-3 col-xs-12'  >
		            <div class="form-group">
		                <div class='input-group date' id='beginFilterDate'>
		                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
		                        <span class="glyphicon glyphicon-calendar"></span>
		                    </span>
		                </div>
		            </div>
		        </div>
		        <div class='col-md-3 col-xs-12'>
		            <div class="form-group">
		                <div class='input-group date' id='endFilterDate'>
		                    <input type='text' class="form-control" autocomplete="off" /> <span class="input-group-addon">
		                        <span class="glyphicon glyphicon-calendar"></span>
		                    </span>
		                </div>
		            </div>
		        </div>
		        <div class='col-md-2 col-xs-12 text-center'>
		        	<button type="button" class="btn btn-do-now" style="width: 86%" onclick="showDashboardReport(true)" > 
		        		<i class="fa fa-check" aria-hidden="true"></i> OK </button>
		        </div>
		    </div>
	       
            <div class="chart_box" >
            	<ul class="nav nav-tabs" data-tab-content="main_dashboard_report_tabs" >   
            		<li class="active">
		         		<a href="javascript:" data-target-tab="panel_observer_report" title="Profile Sources by Observer" > 
		         			<i class="fa fa-dot-circle-o" aria-hidden="true"></i> Customer Data Sources
		         		</a>
		         	</li>	         		
		         	<li>
		         		<a href="javascript:" data-target-tab="panel_touchpoint_report" title="Source Report Details at specific touchpoint" > 
		         			<i class="fa fa-dot-circle-o" aria-hidden="true"></i> Data Source Details
		         		</a>
		         	</li>
		         	<li onclick="showDashboardReport(false)" >
		          		<a href="javascript:" data-target-tab="panel_profile_journey_funnel" title="Profile Journey Report"> 
		          			<i class="fa fa-map-o" aria-hidden="true"></i> Profile Journey  
		          		</a>
		         	</li>
		         	<li>
		         		<a href="javascript:" data-target-tab="panel_profile_funnel" title="Data Funnel Report" > 
		         			<i class="fa fa-filter" aria-hidden="true"></i> Profile Funnel 
		         		</a>
		         	</li>		         		         	
		         	<li>
		         		<a href="javascript:setJourneyFlowGraphView()" data-target-tab="panel_flow_network_report" title="Network Flow Report" > 
		         			<i class="fa fa-connectdevelop" aria-hidden="true"></i> Journey Flow
		         		</a>
		         	</li>
	   			</ul>
	   			
	   			<div class="tab-content" id="main_dashboard_report_tabs" style="min-height: 450px"  >
	   			
	   				<!-- tab 1 Touchpoint Hub Report  -->
					<div class="highlight_box tab-pane active" id="panel_observer_report" >
						<div id="observer_report_wrapper" class="vcenter" ></div>
						<hr>
						<div id="observer_report_table"></div>
					</div>
	   			
					<!-- tab 2 Profile Journey Report  -->
					<div class="highlight_box tab-pane " id="panel_profile_journey_funnel"  >
						<div id="profile_journey_funnel_wrapper" class="vcenter" >
	                  		<div id="profile_journey_funnel" class="funnel" ></div>
	               		</div>
					</div>
					
					<!-- tab 3 Profile Funnel Report  -->
					<div class="highlight_box tab-pane" id="panel_profile_funnel" >
						<div id="profile_funnel_wrapper" class="vcenter" >
	                  		<div id="profile_funnel"></div>
	               		</div>
					</div>
					
					<!-- tab 4 Touchpoint Details Report  -->
					<div class="highlight_box tab-pane" id="panel_touchpoint_report" >
						<div id="touchpoint_report_wrapper" class="vcenter" ></div>
						<hr>
						<div id="touchpoint_report_table"></div>
					</div>
					
					<!-- tab 5 Journey Flow Report  -->
					<div class="tab-pane" id="panel_flow_network_report" >
						<div id="flow_network_report_wrapper" ></div>
					</div>
				</div>
	            
            </div>
            
        </div>
        
        <!-- holder for Total Customer Statistics and Total Event Statistics -->
        <div class="col-md-3"> 
        	<div class="chart_box">
	        		            
	            <div class="panel panel-summary" >
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Summary Report </h4> </div>
				  	<div class="panel-body" id="profile_total_stats">
				  		<!--  Summary: profile, segment, revenue -->
				  	</div>
				</div>
	            
	            <div class="panel panel-marketing">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Marketing Report in Total</h4> </div>
				  	<div class="panel-body" id="marketing_metrics_holder" >
				  	</div>
				</div>
				
				<div class="panel panel-business">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> Sales Report in Total</h4> </div>
				  	<div class="panel-body" id="sales_metrics_holder" >
				  	</div>
				</div>
				
				<div class="panel panel-cx">
            		<div class="panel-heading"> <h4 class="panel-title text-center"> <i class="fa fa-info-circle" aria-hidden="true"></i> CX Report in Total</h4> </div>
				  	<div class="panel-body" id="cx_metrics_holder" >
				  	</div>
				</div>
	            
	       	</div>
        </div>
        
    </div>
   
    <div class="row chart_box" style="display: none;" >
     	<div class="col-md-3" >
     		<div id="customer_source" >
                <h4 class="chart_header" > Media Sources </h4>
            </div>
     	</div>
    	<div class="col-md-12">
	        <h4 class="chart_header" style="width: 100%;" > Total Visitor Statistics of Media Channels </h4>
	        <div id="chart" style="text-align:center;">
	            <svg></svg>
	        </div>
        </div>
    </div>

</div>
<br><br>

<script>

	var mainDashboardFunnelHeight = 420;
	var mainDashboardWidth = 850;
	var dashboardFontSize = 14;
	
	// touchpoint flow network
	var flowNetworkGraph = false;

	//select date
	var currentJourneyMapId = ""; 
    var initPrimaryDashboard = function () {
    	loadJourneyMapList(false, function(id){
    		currentJourneyMapId = id;
    		showDashboardReport(true)
        },true);
    	
    	// init tabs
    	setupTabPanels();
    	
    	updateProfileChartWrapper();		
    	//initDateFilterComponent(false);
    	initDateFilterComponent(false, null, null, 45);
    	
    	mainDashboardWidth = window.pageWrapperWidth > 0 ? (window.pageWrapperWidth * 0.7) : mainDashboardWidth;
    	showDashboardReport(true);
    	
    	//loadEventStatistics()
        
        //loadChannelPerformance();
      	//loadCustomerVenn();
    }
	
	
	
	var updateProfileChartWrapper = function() {
		var container = $('#profile_funnel_wrapper');
		var ws = $(window).width();
		if(ws > 1500 && ws < 1650 ){
			container.css("width","90%");
		}
		else if(ws > 1650 && ws < 1750 ){
			container.css("width","96%");
		}
		else if(ws > 1750 ){
			container.css("width","98%");
		}
		
		var wh = $(window).height();
		var ratio = ws / wh;
		
		if(ratio >= 1.7 && ratio < 2.3 && ws > 1400 && wh > 700){
			mainDashboardFunnelHeight = wh - (Math.floor(window.innerHeight/3) + 186);
			dashboardFontSize = 15;
		}
		else if(ratio >= 2.3 && ws > 1400 && wh > 700){
			mainDashboardFunnelHeight = wh - (Math.floor(window.innerHeight/3) + 116);
			dashboardFontSize = 16;
		}
	}
	
	var dashboardDataModel = false;
	
    var showDashboardReport = function(refresh) {
    	var queryFilter = getDateFilterValues();
    	
    	var beginReportDate = queryFilter.beginFilterDate;
    	$('#beginReportDate').text(new moment(beginReportDate).format(defaultDateFormat))
    	
    	var endReportDate = queryFilter.endFilterDate;
    	$('#endReportDate').text(new moment(endReportDate).format(defaultDateFormat))
        
    	var dataFunnelOptions = {
   	   		block: {
   	   			highlight: true,
	   	   		fill: {
	                type: 'gradient'
	            }
   	   	    },
   	        chart: {
   	         	curve: {
   	                 enabled: true,
   	                 height: 32
   	             },
   	             height: mainDashboardFunnelHeight,
   	             bottomWidth : 0.64,
	             bottomPinch: 2,
	             width: mainDashboardFunnelHeight * 4/3
   	         },
   	         tooltip: {
   	             enabled: true
   	         },
   	         label: {
   	        	fontSize: dashboardFontSize+'px'
   	         },
   	         events: {
   	             click: {
   	                 block: function (data) {
   	                     console.log(data.label.raw);
   	                 }
   	             }
   	         }
   	    };

  	    var visualizeFunnel = function (domSelector, list) {
  	        var data = [];
	  	    for(var i=0; i < list.length; i++){
	  	    	var e = list[i];
	  	    	var value = new Number(e.collectorCount).toLocaleString();
	  	    	var colorCode = getColorCodeProfileFunnel(i+1);
	  			data.push([e.collectorKey, value, colorCode ]);
	  		}
  	        var chart = new D3Funnel(domSelector);
  	        chart.draw(data, dataFunnelOptions);
  	    }
    	
    	var showTotalStatistics = function(profileTotalStats) {
    		// empty 4 data boxes 
    		$('#profile_total_stats').empty();
    		$('#marketing_metrics_holder').empty();
    		$('#sales_metrics_holder').empty();
    		$('#cx_metrics_holder').empty();
    		
    		for(var i=0; i < profileTotalStats.length; i++){
    			var obj = profileTotalStats[i];
    			var label = obj.collectorKey;
				var value = obj.collectorCount;
				var flowType = obj.flowType;
				
    			if(flowType === 0){
    				$('#profile_total_stats').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
    			else if(flowType === 1) {
    				$('#marketing_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
				else if(flowType === 2) {
					$('#sales_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
				else if(flowType === 3) {
					$('#cx_metrics_holder').append('<div class="stats_item" > '+label+' : '+value+' </div>');
    			}
    		}
    	}
    	
        var reportJourneyOfAllProfiles = function(containerId, journeyStatsData) {
        	if(journeyStatsData.length === 0) return; // end
        	var dataModel = {
                labels: journeyLabel5A,
                subLabels: ['VISITOR PROFILE', 'CONTACT PROFILE'],
                colors: [            
                    ['#D6EAF8', '#85C1E9', '#3498DB'],
                    ['#B7F0B7', '#8CF08C', '#5CF45C']
                ],
                values: journeyStatsData
            };
        	var containerWidth = $(containerId).parent().width();
        	var graph = new FunnelGraph({
                container: containerId,
                gradientDirection: 'horizontal',
                data: dataModel,
                displayPercent: true,
                direction: 'horizontal',
                width: containerWidth,
                height: 350,
                subLabelValue: 'percent'
            });
        	graph.draw();
        }
    	
    	var updateChartDashboard = function(){
   			var profileTotalStats = dashboardDataModel.profileTotalStats;
   	        showTotalStatistics(profileTotalStats);
   	        
   	        var profileFunnelData = dashboardDataModel.profileFunnelData;
   	        visualizeFunnel('#profile_funnel', profileFunnelData);
   	        
   	        var journeyStatsData = dashboardDataModel.journeyStatsData;
   	        
   	        $('#profile_journey_funnel').empty();
   	        reportJourneyOfAllProfiles('#profile_journey_funnel', journeyStatsData);
    	}
        
    	if(dashboardDataModel === false || refresh === true){
    		$("#primary_dashboard_loader").show();
        	$("#primary_dashboard").hide();
        	
        	queryFilter['journeyMapId'] = currentJourneyMapId;
        	
        	// journey and funnel report
        	var urlStr = baseLeoAdminUrl + '/cdp/analytics360/dashboard-primary';
            LeoAdminApiUtil.getSecuredData(urlStr, queryFilter , function (json) {
            	$("#primary_dashboard_loader").hide();
            	$("#primary_dashboard").show();
            	
                if (json.httpCode === 0 && json.errorMessage === '') {
                	dashboardDataModel = json.data;
                	updateChartDashboard();
                } else {
                    LeoAdminApiUtil.logErrorPayload(json);
                }
            });
            
            showTouchpointHubReport(queryFilter);
            
            setTimeout(function(){
            	 showTouchpointItemReport(queryFilter);
            },2000)
            
            setTimeout(function(){
            	var containerId = 'flow_network_report_wrapper';
            	showJourneyFlowReport(queryFilter, containerId)
            },3000)
    	}
    	else {
    		updateChartDashboard();
    	}
    }
    
    function showTouchpointHubReport(queryFilter) {
    	var textTitle = "Customer Data Sources";
    	$('#observer_report_wrapper').html('<div class="loader"></div>');
        
        // touchpoint detail report
        queryFilter['touchpointType'] = -1;
        queryFilter['startIndex'] = 0;
        queryFilter['numberResult'] = 22;
        
        var urlStr = baseLeoAdminUrl + '/cdp/analytics360/touchpoint-hub-report';
        LeoAdminApiUtil.getSecuredData(urlStr, queryFilter , function (json) {
			if ( typeof json.data === "object" && json.errorMessage === "") {
				
           	   	var w = mainDashboardWidth;
           	   	var h = 600;
           	   	var canvas = $('<canvas/>').width(w).height(h);
           	   	
           	 	var container = $('#observer_report_wrapper');
           	 	container.empty().append(canvas);
           	 	
           	    // report
           	   	showProfileEventBubbleChart(textTitle, container, canvas, json.data);
           	   	
           	   	setTimeout(function(){
	           	 	var fieldsSchema = [
			        	{ name: "name", title : "Touchpoint Hub Domain", align: 'center' , type: "text" },			        
			        	{ name: "profileCount", title : "Total Profile", type: "number", align: 'center', width: 60 },
			        	{ name: "eventCount", title : "Total Event", type: "number", align: 'center', width: 60 }
			    	];
	           	 	$("#observer_report_table").jsGrid({ editing: false, paging: false, width: "100%", height:"auto", data: json.data, fields: fieldsSchema})
           	   	},1000)
             } else {
                 LeoAdminApiUtil.logErrorPayload(json);
             }
        });
    }
    
    function showTouchpointItemReport(queryFilter){
    	var textTitle = "Data Source Details";
       	$('#touchpoint_report_wrapper').html('<div class="loader"></div>');
        
        // touchpoint detail report
        queryFilter['touchpointType'] = -1;
        queryFilter['startIndex'] = 0;
        queryFilter['numberResult'] = 22;
        var urlStr = baseLeoAdminUrl + '/cdp/analytics360/touchpoint-report';
        LeoAdminApiUtil.getSecuredData(urlStr, queryFilter , function (json) {
        	if ( typeof json.data === "object" && json.errorMessage === "") {
        		
            	var w = mainDashboardWidth;
            	var h = 800;
          	   	var canvas = $('<canvas/>').width(w).height(h);
          	   	
          	  	var container = $('#touchpoint_report_wrapper');
          	   	container.empty().append(canvas);
            	
            	showProfileEventBubbleChart(textTitle, container, canvas, json.data, "touchpoint");
            	
            	var fieldsSchema = [
				        { name: "touchpoint.name", title : "Touchpoint Item Name", align: 'center' , type: "text" },			        
				        { name: "profileCount", title : "Total Profile", type: "number", align: 'center', width: 60 },
				        { name: "eventCount", title : "Total Event", type: "number", align: 'center', width: 60 }
				    ];
          	    $("#touchpoint_report_table").jsGrid({ editing: false, paging: false, width: "100%", height:"auto", data: json.data, fields: fieldsSchema})
            } else {
                LeoAdminApiUtil.logErrorPayload(json);
            }
        });
    }
    

</script>