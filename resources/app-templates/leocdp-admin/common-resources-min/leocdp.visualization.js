'use strict';const chartColorCodes="#000000 #0000FF #8B008B #D2691E #708090 #808080 #800080 #2F4F4F #9932CC #BC8F8F #117A65 #689F38 #D81B60 #33CC66 #336699 #000099 #9C27B0 #C62828 #00BCD4 #6D4C41 #9E9E9E #2196F3".split(" "),MAX_TO_LINE_CHART=chartColorCodes.length,journeyLabel5A=["AWARENESS","ATTRACTION","ASK","ACTION","ADVOCACY"];function randomInteger(b,d){return Math.floor(Math.random()*(d-b+1))+b}
function getColorCodeProfileFunnel(b){var d="#7A9F8D #5D897C #40736D #24585C #225059 #1F4360 #1A2E55 #161C4A #15113E #17202A".split(" ");return 0<=b&&10>=b?d[b-1]:d[0]}
const renderFunnelChart=function(b,d,f,c){var e=[];d.forEach(function(g){var a=g.orderIndex;e.push([g.name,"[Stage "+a+"]",c(a)])});(new D3Funnel(b)).draw(e,f)},renderJourneyFlowChart=function(b,d,f,c,e,g){d={margin:{top:5,left:95,right:45,bottom:5},nodes:{dynamicSizeFontNode:{enabled:!0,minSize:14,maxSize:26},fontSize:16,draggableX:!1,draggableY:!0,colors:d3.scaleOrdinal(d3.schemeCategory20)},links:{formatValue:function(a,h){a=g[a];a='\x3cspan style\x3d"font-weight:bold; margin:5px; background-color:#FFF8DC; border-radius: 6px;"\x3e'+
(a.eventMetrics?a.eventMetrics.join(" \x3cbr\x3e "):"No event metrics");a+="\x3c/b\x3e";var k="\x3cb\x3e"+d3.format(",.0f")(h)+"\x3c/b\x3e";return h&&1<h?k+" "+a:a},unit:d},tooltip:{infoDiv:!0,labelSource:"Input:",labelTarget:"Output:"}};sk.createSankey(b,d,{nodes:c,links:e});$(b+" g.sk-node text").each(function(){var a=$(this).text().trim(),h=g[a];"object"===typeof h?(a="["+h.journeyLevel+"] "+a,$(this).html(a)):console.error("touchpointHubMap[name] is NULL for name: "+a)})},renderSegmentSize=function(b,
d,f,c,e,g,a){g=Math.floor(.97*g);g=d3.arc().outerRadius(g).innerRadius(110);var h=d3.pie().sort(null).value(function(k){return k.count});b=d3.select(b).append("svg").attr("width",c).attr("height",e).append("g").attr("transform","translate("+c/2+","+e/2+")").selectAll(".arc").data(h(d)).enter().append("g");b.append("path").attr("d",g).style("fill",function(k,n){return k.data.color});f='\x3ctspan y\x3d"0" \x3e Segment Size: '+f.toLocaleString()+"\x3c/tspan\x3e";a='\x3ctspan y\x3d"24" \x3e'+a+"% of Total Profile \x3c/tspan\x3e";
b.append("text").attr("text-anchor","middle").attr("font-size","1.1em").attr("y",20).html(f);b.append("text").attr("text-anchor","middle").attr("font-size","1.1em").attr("y",20).html(a)},loadMediaTouchpoints=function(){var b=venn.VennDiagram().width(500).height(400),d=d3.select("#venn_two").datum([{sets:["Email"],figure:27.92,label:"Email",size:27.92},{sets:["Direct Traffic"],figure:55.28,label:"Direct Traffic",size:55.28},{sets:["Search Engine"],figure:7.62,label:"Search Engine",size:7.62},{sets:["Email",
"Direct Traffic"],figure:3.03,label:"Email and Direct Traffic",size:3.03},{sets:["Email","Search Engine"],figure:1.66,label:"Email and Search Engine",size:1.66},{sets:["Direct Traffic","Search Engine"],figure:2.4,label:"Direct Traffic and Search Engine",size:2.4},{sets:["Email","Direct Traffic","Search Engine"],figure:1.08,label:"Email, Direct Traffic, and Search Engine",size:1.08}]).call(b);d.selectAll("text").style("fill","white");d.selectAll(".venn-circle path").style("fill-opacity",.8).style("stroke-width",
1).style("stroke-opacity",1).style("stroke","fff");var f=d3.select("body").append("div").attr("class","venntooltip");d.selectAll("g").on("mouseover",function(c,e){venn.sortAreas(d,c);f.transition().duration(40).style("opacity",1);f.text(c.size+"% media touchpoint "+c.label);d3.select(this).transition("tooltip").duration(400).select("path").style("stroke-width",3).style("fill-opacity",1==c.sets.length?.8:0).style("stroke-opacity",1)}).on("mousemove",function(){f.style("left",d3.event.pageX+"px").style("top",
d3.event.pageY-28+"px")}).on("mouseout",function(c,e){f.transition().duration(2500).style("opacity",0);d3.select(this).transition("tooltip").duration(400).select("path").style("stroke-width",3).style("fill-opacity",1==c.sets.length?.8:0).style("stroke-opacity",1)})},personalityDiagram=function(){d3.select("chart_persornality").append("svg").attr("width",300).attr("height",300);RadarChart.draw("#chart_persornality",[[{area:"Openness",value:80},{area:"Conscientiousness",value:40},{area:"Extraversion ",
value:40},{area:"Agreeableness ",value:90},{area:"Neuroticism ",value:60}]],{w:300,h:300,maxValue:100,levels:5,ExtraWidthX:300})},loadProfileAttribution=function(){var b=Math.round($("#profile_attribution").width())-140-60,d=d3.select("#profile_attribution").append("svg").attr("width",b+140+60).attr("height",550).append("g").attr("transform","translate(140,30)"),f=d3.scaleBand().range([0,b]).domain(["Live_in_Saigon","Visited_Web","Installed_App","Used_Credit_Card","Buy_Product"]).padding(.01);d.append("g").attr("transform",
"translate(0,420)").attr("class","x_axis").call(d3.axisBottom(f)).selectAll("text").attr("transform","translate(-10,10)rotate(-30)").style("text-anchor","end").style("font-size",15).style("fill","#E91E0D");var c=d3.scaleBand().range([420,0]).domain(["Buy_Product","Used_Credit_Card","Installed_App","Visited_Web","Live_in_Saigon"]).padding(.01);d.append("g").attr("class","y_axis").call(d3.axisLeft(c)).selectAll("text").style("text-anchor","end").style("font-size",15).style("fill","#463CC4");var e=d3.scaleLinear().range(["white",
"#008748"]).domain([1,100]);b="/public/uploaded-files/sample-profile-attribution.csv?_\x3d"+(new Date).getTime();d3.csv(b,function(g){d.selectAll().data(g,function(a){return a.profile_attr+":"+a.persona_attr}).enter().append("rect").attr("id",function(a){return"cell_"+a.profile_attr+"_"+a.persona_attr}).attr("x",function(a){return f(a.profile_attr)}).attr("y",function(a){return c(a.persona_attr)}).attr("width",f.bandwidth()).attr("height",c.bandwidth()).style("fill",function(a){return e(a.matching_score)}).on("click",
function(a){var h=" [Profile attribute: "+a.profile_attr+" - Persona attribute: "+a.persona_attr+"] : Matching Score \x3d "+a.matching_score+" %";$("#attribution_description").text(h);d.select("#cell_"+a.profile_attr+"_"+a.persona_attr);h=" [Profile attribute: "+a.profile_attr+" - Persona attribute: "+a.persona_attr+"] : Matching Score \x3d "+a.matching_score+" %";$("#attribution_description").text(h).effect("highlight",{color:"#5eeb34"},6E3)}).on("mouseover",function(a){console.log(a);d.select("#cell_"+
a.profile_attr+"_"+a.persona_attr).style("fill","#5eeb34");a=" [Profile attribute: "+a.profile_attr+" - Persona attribute: "+a.persona_attr+"] : Matching Score \x3d "+a.matching_score+" %";$("#attribution_description").text(a)}).on("mouseout",function(a){d.select("#cell_"+a.profile_attr+"_"+a.persona_attr).style("fill",e(a.matching_score))})})};
function loadCustomerVenn(){var b=venn.VennDiagram().width($("#customer_source").width()).height(360),d=d3.select("#customer_source").datum([{sets:["Email"],figure:27.92,label:"Email",size:27.92},{sets:["Social Media"],figure:55.28,label:"Social Media",size:55.28},{sets:["Search Engine"],figure:7.62,label:"Search Engine",size:7.62},{sets:["Email","Social Media"],figure:3.03,label:"",size:3.03},{sets:["Email","Search Engine"],figure:2.66,label:"",size:1.66},{sets:["Social Media","Search Engine"],figure:2.4,
label:"",size:2.4},{sets:["Email","Social Media","Search Engine"],figure:1.08,label:"",size:1.08}]).call(b);d.selectAll("text").style("fill","white");d.selectAll(".venn-circle path").style("fill-opacity",.8).style("stroke-width",1).style("stroke-opacity",1).style("stroke","fff");var f=d3.select("body").append("div").attr("class","venntooltip");d.selectAll("g").on("mouseover",function(c,e){venn.sortAreas(d,c);f.transition().duration(40).style("opacity",1);f.text(c.size+"% of Segment Two saw "+c.label);
d3.select(this).transition("tooltip").duration(400).select("path").style("stroke-width",3).style("fill-opacity",1==c.sets.length?.8:0).style("stroke-opacity",1)}).on("mousemove",function(){f.style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(c,e){f.transition().duration(2500).style("opacity",0);d3.select(this).transition("tooltip").duration(400).select("path").style("stroke-width",3).style("fill-opacity",1==c.sets.length?.8:0).style("stroke-opacity",1)})}
function loadChannelPerformance(){var b=[{channelName:"Ecommerce Website",lead:181},{channelName:"Ecommerce App",lead:189},{channelName:"Social Media Groups",lead:387},{channelName:"Retail Store",lead:187},{channelName:"Book Reseller",lead:52}],d=$("#chart").width()-180-20,f=d3.scaleBand().range([300,0]).padding(.1),c=d3.scaleLinear().range([0,d]);d=d3.select("#chart svg").attr("width",d+180+20).attr("height",350).append("g").attr("transform","translate(180,20)");b.forEach(function(e){e.lead=+e.lead});
c.domain([0,d3.max(b,function(e){return e.lead})]);f.domain(b.map(function(e){return e.channelName}));d.selectAll(".bar").data(b).enter().append("rect").attr("class","bar").attr("width",function(e){return c(e.lead)}).attr("y",function(e){return f(e.channelName)}).attr("height",f.bandwidth());d.append("g").attr("transform","translate(0,300)").call(d3.axisBottom(c));d.append("g").call(d3.axisLeft(f))}
var renderTimeseriesChart=function(b,d,f,c,e){var g={labels:[],datasets:[]},a=[],h=getRawDateFilterValues(),k=h.beginFilterDate;for(h=h.endFilterDate;k.isBefore(h,"day");)a.push(k.format("YYYY-MM-DD")),k.add(1,"days");g.labels=a;var n=0;Object.keys(d.reportMap).forEach(function(q){var l={};d.reportMap[q].forEach(function(m){var p=m.dateKey;m=m.dailyCount;l[p]=l[p]?l[p]:0;l[p]+=m});var r=[];g.labels.forEach(function(m){r.push(l[m]?l[m]:0)});var t=chartColorCodes[n];n+=1;var u=!0;n>=MAX_TO_LINE_CHART&&
(n=0,u=!1);var v=0<q.indexOf("view")||0<q.indexOf("click")||!0===e?!1:!0;g.datasets.push({label:q,backgroundColor:t,borderColor:t,fill:!1,borderWidth:1.5,tension:.2,showLine:u,hidden:v,data:r})});if(!0===f&&"object"===typeof c)c.data=g,c.update();else return f=(f=$("#"+b).data("chart-type"))?f:"line",b=document.getElementById(b).getContext("2d"),new Chart(b,{type:f,data:g,options:{tooltips:{mode:"index",intersect:!0},responsive:!0,interaction:{pointHoverRadius:10,intersect:!0,mode:"index"},scales:{xAxes:{stacked:!1},
yAxes:{stacked:!0}}}})};
const PluginCenterTextChartJS=function(){return{beforeDraw:function(b,d,f){var c=b.data.donutChartCenterData;if("object"===typeof c){d="number"===typeof c.value?c.value:0;f="number"===typeof c.marginTop?c.marginTop:30;c="string"===typeof c.suffix?c.suffix:"";var e=b.width,g=b.height;b=b.ctx;b.restore();var a=(g/114).toFixed(2);b.font=a+"em sans-serif";b.textBaseline="middle";a=d;e=Math.round((e-b.measureText(a).width)/2);"string"===typeof c&&(a+=c,e-=10);0<=d?b.fillStyle="#1EC900":(b.fillStyle="#E80015",
e+=4);b.fillText(a,e,g/2+f);b.save()}}}},renderDonutChartJs=function(b,d){b=document.getElementById(b).getContext("2d");return new Chart(b,{type:"doughnut",data:d,options:{title:{display:!1,text:"Overall CX Score",fontSize:15},responsive:!0,maintainAspectRatio:!0,showDatapoints:!0,legend:{display:!0},plugins:{datalabels:{color:"black",formatter:function(f){return f+"%"},font:{weight:"bold",size:15}}}},plugins:[PluginCenterTextChartJS(),ChartDataLabels]})},renderStackedBarChart=function(b,d){b=document.getElementById(b).getContext("2d");
return new Chart(b,{type:"bar",data:d,options:{tooltips:{mode:"index",intersect:!1},responsive:!0,interaction:{mode:"index"},scales:{xAxes:{stacked:!0},yAxes:{stacked:!0}}}})};
function updateTouchpointReport(b){var d=0<b.length?b[0].profileCount+15:10,f=[];b.forEach(function(c,e){var g=c.profileCount,a=c.eventCount;f.push({label:textTruncate(c.touchpoint.name,70),backgroundColor:chartColorCodes[e],borderColor:"#107CC5",data:[{x:a,y:g,r:10}]})});b={type:"bubble",data:{datasets:f},options:{plugins:{legend:{display:!0,position:"bottom",labels:{font:{size:12}}},title:{text:"Touchpoint Report",display:!0,font:{size:18},color:"#0000CD"},tooltip:{callbacks:{label:function(c){let e=
c.dataset.label||"";e&&(e+=" | ");null!==c.parsed.y&&(e+="Profile: "+c.parsed.y);null!==c.parsed.x&&(e+=" | Event: "+c.parsed.x);return e}}}},responsive:!1,aspectRatio:1,showDatapoints:!1,scales:{y:{title:{text:"Profile",display:!0,font:{size:16},color:"#0000CD",align:"end"},beginAtZero:!0,max:d,ticks:{stepSize:4,callback:function(c,e,g){return c}}},x:{title:{text:"Event",display:!0,font:{size:16},color:"#0000CD",align:"end"},beginAtZero:!0,ticks:{stepSize:4,callback:function(c,e,g){return c}}}}}};
d=$("#main_dashboard_report_tabs").width()-6;d=$("\x3ccanvas/\x3e").width(d).height(700);$("#touchpoint_report_wrapper").empty().append(d);d=d[0].getContext("2d");new Chart(d,b)};