'use strict';const loadSystemEventsTable=function(d,b,a,f,c,g,h){var l=getUserSession();if(l){d=_.template($("#system-event-table-tpl").html())({eventObjectName:d});$("#"+b).empty().html(d);var n=[{data:"createdAt"},{data:"action"},{data:"accessIp"},{data:"userAgent"},{data:"data"}];h="object"===typeof h?h:[20,30,40];return $("#system_event_table").DataTable({lengthMenu:[h,h],lengthChange:1<h.length?!0:!1,processing:!0,serverSide:!0,searching:!1,search:{return:!1},ordering:!0,serverMethod:"POST",
ajax:{url:baseLeoAdminUrl+"/cdp/system-control/action-logs",contentType:"application/json",beforeSend:function(e){$("#system_event_loader").show();$("#system_event_list").hide();e.setRequestHeader("leouss",l)},data:function(e){e.objectName=a;e.objectId=f;e.action="";e.accessIp="";e.requestUserLogin=c;var k=e.order[0];e.sortField=n[k.column].data;e.sortAsc="asc"===k.dir;e.searchValue=e.search.value;delete e.order;delete e.search;return JSON.stringify(e)},dataSrc:function(e){var k=e.canInsertData,m=
e.canEditData,p=e.canDeleteData;$("#system_event_table").data("canInsertData",k);$("#system_event_table").data("canEditData",m);$("#system_event_table").data("canDeleteData",p);$("#system_event_loader").hide();$("#system_event_list").show();"function"===typeof g&&g();return e.data}},columnDefs:[{render:function(e,k,m){return'\x3cdiv class\x3d"text-center" style\x3d"color:#3300ff; width:78px; margin: auto;" \x3e\x3cmark\x3e'+moment.utc(e).local().format("YYYY-MM-DD HH:mm:ss")+"\x3c/mark\x3e\x3c/div\x3e"},
targets:0},{render:function(e,k,m){return'\x3cdiv style\x3d"font-size:0.9em; width:160px; text-align:center; margin: auto;word-wrap: break-word;" \x3e\x3cmark\x3e'+e+"\x3c/mark\x3e\x3c/div\x3e"},targets:1,orderable:!1},{render:function(e,k,m){return'\x3cdiv style\x3d"font-size:0.9em; text-align:center; margin: auto; word-wrap: break-word;"\x3e\x3cmark\x3e'+e+"\x3c/mark\x3e\x3c/div\x3e"},targets:2,orderable:!1},{render:function(e,k,m){return'\x3cdiv style\x3d"font-size:0.8em; text-align:center; width:260px; margin: auto; word-wrap: break-word;" \x3e'+
e+"\x3c/div\x3e"},targets:3,orderable:!1},{render:function(e,k,m){return'\x3cdiv style\x3d"font-size:0.78em; word-wrap: break-word; width:400px; margin: auto;" \x3e'+textTruncate(e,300)+"\x3c/div\x3e"},targets:4,orderable:!1}],columns:n,order:[[0,"desc"]]})}},loadSystemEventsFromLoginUser=function(d){return loadSystemEventsTable("User Login","panel_login_account_view_logs","SystemUser","",d)};
var loadSystemInfoConfigs=function(){LeoAdminApiUtil.getSecuredData("/cdp/system-config/list-all",{},function(d){var b=$("#configs_holder");_.forEach(d.data,function(a,f){f=a.id;systemConfigMap[f]=a;a.disabledText=a.configs.read_only?"disabled":"";a.enterpriseEditionText=a.configs.active?"":"(only available in the Enterprise edition)";a.service_api_key=a.configs.service_api_key&&""!=a.configs.service_api_key?a.configs.service_api_key.substr(0,5)+"...":"";if(!0===a.configs.show){var c=_.template($("#tpl_system_config_box").html());
b.append(c(a));$("#header_"+f+"_true").css("color","#0000CD");"local-system"===a.configs.service_api_url&&($("#"+f+"_buttons_div").find("button").attr("disabled","disabled"),$("#"+f+"_api_key_div").css("visibility","hidden"));$("#"+f+"_api_key").focus(function(){$(this).val("")});1===a.status&&$("#"+f+"_api_key_label").html('\x3ci class\x3d"fa fa-check" aria-hidden\x3d"true"\x3e\x3c/i\x3e API Key is ready').addClass("config_ready")}});b.find("div.active_false button").attr("class","btn btn-default").attr("disabled",
"disabled");b.find("div.panel_active_false").find("input").attr("disabled","disabled");b.find("i.config_description").tooltip();d=_.map(systemConfigMap.profile_data_fields.coreFieldConfigs,function(a,f){return 0<a.dataQualityScore?(a.coreAttribute=!0,a):!1});d=_.filter(d,function(a){return!1!==a});d=_.sortBy(d,[function(a){return a.identityResolution?1E3*a.dataQualityScore:a.dataQualityScore}]).reverse();$("#profileAttributeCount").text(d.length);renderProfileMetaDataTable(d)})};
function renderProfileMetaDataTable(d){$("#profile_metadata_table").jsGrid({data:d,width:"100%",height:"auto",inserting:!1,editing:!0,sorting:!0,paging:!1,confirmDeleting:!0,deleteConfirm:function(b){return b.coreAttribute?"The attribute \x3cb\x3e["+b.attributeName+"]\x3c/b\x3e is the \x3cb\x3eattribute of system\x3c/b\x3e. You can not delete this attribute.":"The attribute ["+b.attributeName+"] will be removed. Are you sure ? "},onItemInserting:function(b){},onItemInserted:function(b){},onItemEditing:function(b){},
onItemUpdated:function(b){var a=b.item;console.log(a);b=systemConfigMap.profile_data_fields;var f=b.coreFieldConfigs[a.attributeName];f&&(f.dataQualityScore=a.dataQualityScore,b={objectJson:JSON.stringify(b)},LeoAdminApiUtil.callPostAdminApi("/cdp/system-config/save",b,function(c){0===c.httpCode&&""===c.errorMessage?notifySuccessMessage("The attribute \x3cb\x3e["+a.attributeName+"]\x3c/b\x3e is saved successfully !"):LeoAdminApiUtil.logErrorPayload(c)}))},onItemDeleting:function(b){},onRefreshed:function(b){},
fields:[{name:"identityResolution",title:"Identity Resolution Key",align:"center",type:"CustomCheckBox",width:64,sorter:"string",editTemplate:function(b){return'\x3cdiv class\x3d"text-center"\x3e'+getCheckedBoxIcon(b)+"\x3c/div\x3e"}},{name:"attributeName",title:"Attribute Name",align:"center",type:"text",validate:"required",validate:"required",editing:!1},{name:"label",title:"Label",align:"center",type:"text",validate:"required",width:120,editing:!1},{name:"type",title:"Data Type",align:"center",
type:"text",validate:"required",editing:!1,itemTemplate:function(b,a){a=b.lastIndexOf(".")+1;b=0<a?b.substr(a):b;return'\x3cdiv class\x3d"profile_field_type"\x3e '+b+" \x3c/div\x3e"}},{name:"dataQualityScore",title:"Data Quality Score",type:"number",align:"center",width:76,validate:"required",itemTemplate:function(b,a){return 0<b?'\x3cdiv class\x3d"highlight_text positive_dqs"\x3e '+b+" \x3c/div\x3e":0>b?'\x3cdiv class\x3d"highlight_text negative_dqs"\x3e '+b+" \x3c/div\x3e":b}},{name:"synchronizable",
title:"Synchronizable ",align:"center",type:"CustomCheckBox",width:64,validate:"required",sorter:"string"},{title:"Controls",type:"control",width:80,editButton:!0,deleteButton:!1,itemTemplate:function(b,a){jsGrid.fields.control.prototype.itemTemplate.apply(this,arguments);var f=a.coreAttribute,c=a.attributeName;var g="Edit Event Name: "+c;$("\x3cbutton\x3e").data("attributeName",c).attr({class:"jsgrid-custom-button",title:g}).html('\x3ci class\x3d"fa fa-cogs event-set-rules" style\x3d"" aria-hidden\x3d"true"\x3e\x3c/i\x3e').click(function(l){console.log("setRules button ",
$(this).data("attributeName"));underDevelopment(this);l.stopPropagation()});var h="customGridEditbutton jsgrid-button jsgrid-edit-button";g=$("\x3cbutton\x3e").data("attributeName",c).attr({class:h,title:"Edit Attribute"}).click(function(l){console.log("Edit button ",$(this).data("attributeName"))});h="customGridDeletebutton jsgrid-button jsgrid-delete-button";c=$("\x3cbutton\x3e").data("attributeName",c).attr({class:h,title:"Delete Attribute"}).click(function(l){var n=$(this).data("attributeName");
f?notifyErrorMessage("The attribute \x3cb\x3e["+n+"]\x3c/b\x3e is the \x3cb\x3eattribute of system\x3c/b\x3e. You can not delete this attribute."):deleteEventMetricMetaData(n);l.stopPropagation()});h=$("\x3cdiv\x3e");f?h.attr("title","The attribute of system"):(h.addClass("editable_profile_attribute"),h.attr("title","Click to edit or delete"));h.append(g).append(c);return h}}]})}
function callDataQualityComputeJob(){LeoAdminApiUtil.callPostAdminApi("/cdp/system-config/call-data-quality-compute-job",{},function(d){0===d.httpCode&&""===d.errorMessage?iziToast.success({title:"Information Box",message:"\x3cb\x3eCall Data Quality Compute Job\x3c/b\x3e is called successfully!"}):LeoAdminApiUtil.logErrorPayload(d)})}
function deleteSystemServiceInfo(d){var b=systemConfigMap[d];_.forOwn(b.configs,function(c,g){"string"!==typeof c||0!==g.indexOf("smtp_")&&0!==g.indexOf("service_")||(b.configs[g]="")});$("#"+d+"_api_key").val("");$("#"+d+"_api_url").val("");b.status=0;var a=function(c){null!=c?(iziToast.success({title:"System Config",message:"The config of \x3cb\x3e"+b.name+"\x3c/b\x3e is reset OK!",timeout:3E3}),$("#"+d+"_api_key").val(""),$("#"+d+"_api_key_label").html("API Key").removeClass("config_ready")):console.error("saveSystemServiceInfo ",
c)},f={objectJson:JSON.stringify(b)};LeoAdminApiUtil.callPostAdminApi("/cdp/system-config/save",f,function(c){0===c.httpCode&&""===c.errorMessage?a(c.data):LeoAdminApiUtil.logErrorPayload(c)},a)}
function saveSystemServiceInfo(d){var b=$(d).data("id"),a=systemConfigMap[b],f={};$("#"+b+"_api_key").val().trim();$("#systemServiceConfigList input").each(function(){var g=$(this).attr("name"),h=$(this).attr("type");f[g]="number"===h?parseInt($(this).val()):"checkbox"===h?$(this).prop("checked"):$(this).val()});a.configs=f;a.status=a.configs.service_api_key&&""!=a.configs.service_api_key?1:0;d={objectJson:JSON.stringify(a)};var c=function(g){if(null!=g){$("#dialogSetSystemConfigs").modal("hide");
iziToast.success({title:"System Config",message:"The config of \x3cb\x3e"+a.name+"\x3c/b\x3e is saved OK!",timeout:3E3});g=f.service_api_key.substr(0,5)+"...";var h=f.service_api_url;$("#"+b+"_api_key").val(g);$("#"+b+"_api_url").val(h);1===a.status&&$("#"+b+"_api_key_label").html('\x3ci class\x3d"fa fa-check" aria-hidden\x3d"true"\x3e\x3c/i\x3e API Key is ready').addClass("config_ready")}else console.error("saveSystemServiceInfo ",g)};LeoAdminApiUtil.callPostAdminApi("/cdp/system-config/save",d,
function(g){0===g.httpCode&&""===g.errorMessage?c(g.data):LeoAdminApiUtil.logErrorPayload(g)},c)}
function setSystemServiceInfo(d){var b=systemConfigMap[d];$("#dialogSetSystemConfigs").modal({backdrop:"static",keyboard:!1});$("#systemServiceName").text(b.name);$("#systemServiceDescription").text(b.description);$("#systemServiceSaveButton").data("id",d);var a=$("#systemServiceConfigList");a.empty();_.forOwn(b.configs,function(f,c){var g={inputName:c};g.inputType="number"===typeof f?"number":"boolean"===typeof f?"checkbox":"text";var h=_.template($("#tpl_config_row_item").html());a.append(h(g));
"checkbox"===g.inputType?a.find('input[name\x3d"'+c+'"]').prop("checked",f):a.find('input[name\x3d"'+c+'"]').val(f);if(0===c.indexOf("service")||0===c.indexOf("smtp_"))a.find('input[name\x3d"'+c+'"]').prop("disabled",!1),$("#config_label_"+c).addClass("highlight_text")})};